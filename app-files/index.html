<!DOCTYPE html>
<html lang="it">
<head>
<title>Tour 360 Pro - Valle dell'Adige</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
<!-- Preconnect ai CDN per velocizzare il caricamento -->
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>
<link rel="dns-prefetch" href="https://server.arcgisonline.com" />
<link rel="dns-prefetch" href="https://basemaps.cartocdn.com" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<link rel="stylesheet" href="vendor/reset.min.css">
<link rel="stylesheet" href="style.css">
<style>
    :root {
        --bg: #111;
        --text: #ddd;
        --accent: #3498db;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body, html { height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }
    
    /* Ottimizza touch per mobile - touch-action: manipulation permette pinch-to-zoom di Marzipano */
    #pano {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: #000;
        touch-action: manipulation;
        cursor: grab;
    }
    #pano:active {
        cursor: grabbing;
    }

    /* Widget info moderno in alto a sinistra con animazione */
    #top-left-controls {
        position: absolute;
        top: 15px;
        left: 15px;
        z-index: 150;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    #info-widget {
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(10px);
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 50px;
        overflow: hidden;
        white-space: nowrap;
    }

    #info-widget.active {
        max-width: 400px;
    }

    #info-widget:hover {
        background: rgba(0, 0, 0, 0.85);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.6);
    }

    #info-icon {
        display: inline-block;
        width: 24px;
        height: 24px;
        line-height: 24px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        color: #3498db;
        flex-shrink: 0;
    }

    #info-text {
        display: inline-block;
        margin-left: 10px;
        opacity: 0;
        transform: translateX(-10px);
        transition: all 0.3s ease;
    }

    #info-widget.active #info-text {
        opacity: 1;
        transform: translateX(0);
    }

    #info-text-title {
        font-size: 16px;
        font-weight: bold;
        color: #3498db;
        margin-bottom: 4px;
    }

    #info-text-content {
        font-size: 13px;
        color: #ddd;
        line-height: 1.4;
    }

    /* Bottone lingua moderno */
    #lang-toggle {
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(10px);
        border: none;
        padding: 10px 14px;
        border-radius: 10px;
        color: white;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    #lang-toggle:hover {
        background: rgba(52, 152, 219, 0.9);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(52, 152, 219, 0.5);
    }

    /* Mappa con header elegante */
    #map-box {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 320px;
        max-height: 70vh;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 100;
    }

    .map-header {
        background: linear-gradient(135deg, #3498db, #2980b9);
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid rgba(255,255,255,0.1);
    }

    .map-header h3 {
        font-size: 15px;
        font-weight: 600;
        color: white;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    #mapContainer {
        width: 100%;
        height: 400px;
        transition: height 0.3s ease;
    }

    #map-box.collapsed #mapContainer {
        height: 0;
    }

    .map-attribution {
        padding: 6px 10px;
        font-size: 10px;
        color: #aaa;
        background: rgba(0,0,0,0.5);
        text-align: center;
    }

    .map-controls, .map-controls-right {
        position: absolute;
        display: flex;
        gap: 8px;
        z-index: 1000;
    }

    .map-controls {
        bottom: 50px;
        left: 10px;
    }

    .map-controls-right {
        top: 60px;
        right: 10px;
        flex-direction: column;
    }

    .map-btn {
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(8px);
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        color: white;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .map-btn:hover {
        background: rgba(52, 152, 219, 0.9);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(52, 152, 219, 0.5);
    }

    #layer-menu {
        position: absolute;
        top: 60px;
        right: 10px;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(12px);
        border-radius: 10px;
        padding: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.6);
        display: none;
        z-index: 1001;
        min-width: 160px;
    }

    #layer-menu.visible {
        display: block;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .layer-item {
        padding: 10px 12px;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s ease;
        font-size: 13px;
        color: #ddd;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .layer-item:hover {
        background: rgba(52, 152, 219, 0.2);
        color: white;
    }

    .layer-item.active {
        background: rgba(52, 152, 219, 0.4);
        color: white;
        font-weight: 600;
    }

    .layer-item::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: transparent;
        border: 2px solid #666;
        transition: all 0.2s ease;
    }

    .layer-item.active::before {
        background: #3498db;
        border-color: #3498db;
    }

    #layer-toggle {
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(8px);
        border: none;
        padding: 10px 14px;
        border-radius: 8px;
        color: white;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    #layer-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.6);
    }

    #layer-toggle:focus {
        outline: 3px solid rgba(255,255,255,0.06);
    }

    /* HOTSPOT NATIVO (CENTRATO) */
    .hotspot-info {
        width: 48px;
        height: 48px;
        margin-left: -24px;
        margin-top: -24px;
        background: radial-gradient(circle, rgba(52, 152, 219, 0.3), transparent 70%);
        border: 3px solid rgba(52, 152, 219, 0.9);
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse-white 2s infinite;
        box-shadow: 0 4px 20px rgba(52, 152, 219, 0.4),
                    inset 0 0 15px rgba(52, 152, 219, 0.2);
        backdrop-filter: blur(4px);
    }

    .hotspot-info:hover {
        transform: scale(1.08);
        box-shadow: 0 12px 26px rgba(52, 152, 219, 0.5);
        background: rgba(52, 152, 219, 0.4);
    }

    .hotspot-info .hotspot-plus {
        font-size: 28px;
        color: white;
        font-weight: bold;
        text-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }

    @keyframes pulse-white {
        0%, 100% { box-shadow: 0 4px 20px rgba(52, 152, 219, 0.4), inset 0 0 15px rgba(52, 152, 219, 0.2); }
        50% { box-shadow: 0 8px 30px rgba(52, 152, 219, 0.7), inset 0 0 20px rgba(52, 152, 219, 0.4); }
    }

    /* CONTROL BAR (BARRA A DUE LIVELLI) */
    #control-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.85));
        backdrop-filter: blur(15px);
        padding: 12px 20px;
        box-shadow: 0 -4px 30px rgba(0,0,0,0.7);
        z-index: 200;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    /* ICONE SVG ELEGANTI */
    .control-btn svg,
    #bar-toggle svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
        transition: all 0.3s ease;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    /* Hover effect */
    .control-btn:hover svg,
    #bar-toggle:hover svg {
        filter: drop-shadow(0 4px 8px rgba(52, 152, 219, 0.6));
        transform: scale(1.1);
    }

    /* Su mobile le icone devono essere leggermente pi√π grandi */
    @media (max-width: 768px) {
        .control-btn svg,
        #bar-toggle svg {
            width: 22px;
            height: 22px;
        }
    }

    #control-bar.collapsed {
        transform: translateY(calc(100% - 50px));
        padding-bottom: 50px;
    }

    #bar-toggle {
        position: absolute;
        top: -40px;
        right: 20px;
    }

    #bar-toggle.collapsed {
        top: -40px;
    }

    #control-bar.collapsed #control-bar-top,
    #control-bar.collapsed #control-bar-bottom {
        opacity: 0;
        pointer-events: none;
    }

    #controls-wrapper.collapsed #gallery-toggle-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        opacity: 1;
        pointer-events: all;
        background: rgba(0,0,0,0.75);
        padding: 8px 16px;
        border-radius: 20px;
    }

    #control-bar.collapsed::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 50px;
        background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
        pointer-events: none;
    }

    /* TOGGLE BUTTON (espansione orizzontale) - posizionato a destra del titolo */
    #bar-toggle {
        position: absolute;
        top: -40px;
        right: 20px;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(10px);
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        color: white;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 -4px 16px rgba(0,0,0,0.5);
        z-index: 201;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #bar-toggle:hover {
        background: rgba(52, 152, 219, 0.9);
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 -6px 20px rgba(52, 152, 219, 0.5);
    }

    #bar-toggle.collapsed {
        transform: rotate(180deg);
    }

    /* TOP ROW */
    #control-bar-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
    }

    #control-bar-top .control-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    /* I gruppi laterali non occupano spazio extra, cos√¨ la didascalia pu√≤ allargarsi */
    #control-bar-top .control-group:first-of-type,
    #control-bar-top .control-group:last-of-type {
        flex-shrink: 0;
    }

    #control-bar-top .control-group:last-of-type {
        justify-content: flex-end;
    }

    /* Impedisci ai bottoni di comprimersi quando lo spazio √® poco */
    #control-bar-top .control-group:last-of-type {
        min-width: fit-content;
    }

    #control-bar-top .control-group .control-btn {
        flex-shrink: 0;
    }

    /* Impedisci ai gruppi di bottoni di schiacciarsi */
    .control-group {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-shrink: 0;
    }

    /* BOTTOM ROW (118px) */
    #control-bar-bottom {
        display: flex;
        align-items: center;
        gap: 12px;
        height: 118px;
    }

    /* Gestione testo centrale con i puntini (...) */
    #scene-caption {
        flex: 1;
        text-align: center;
        font-size: 18px;
        font-weight: 600;
        color: white;
        letter-spacing: 0.5px;
        text-shadow: 0 2px 8px rgba(0,0,0,0.5);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
        padding: 0 15px;
    }

    .thumb-row {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        min-width: 0;
    }

    /* THUMBNAILS STRIP */
    #thumb-track {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        scroll-behavior: smooth;
        padding: 5px 0;
        flex: 1;
        min-width: 0;
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    #thumb-track::-webkit-scrollbar {
        display: none;
    }

    .thumb-item {
        position: relative;
        width: 140px;
        height: 105px;
        flex-shrink: 0;
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        border: 3px solid transparent;
    }

    .thumb-item::after {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.3);
        transition: all 0.3s ease;
    }

    .thumb-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center 40%;
    }

    /* Stile base miniatura attiva: bordo bianco + pulsazione */
    .thumb-item.active {
        border-color: #3498db;
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6);
        transform: scale(1.05);
        animation: thumb-pulse 2s infinite;
    }

    /* Animazione di pulsazione (simile all'hotspot) */
    @keyframes thumb-pulse {
        0%, 100% { box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6); }
        50% { box-shadow: 0 8px 28px rgba(52, 152, 219, 0.9); }
    }

    /* Effetto hover migliorato */
    .thumb-item:hover {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 8px 24px rgba(52, 152, 219, 0.5);
    }

    /* CONTROL BUTTONS */
    .control-btn {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 10px 14px;
        border-radius: 10px;
        color: white;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .control-btn:hover {
        color: #67b6ff;
        transform: translateY(-1px);
        background: rgba(255,255,255,0.06);
    }

    .control-btn:active {
        transform: translateY(0);
    }

    .control-btn svg {
        width: 18px;
        height: 18px;
        fill: currentColor;
    }

    .strip-btn svg {
        width: 18px;
        height: 18px;
        fill: currentColor;
    }

    /* Pulsante rotazione minimal */
    #rotation-toggle {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 10px 14px;
        border-radius: 10px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    #rotation-toggle:hover {
        color: #67b6ff;
        background: rgba(255,255,255,0.06);
        transform: translateY(-1px);
    }

    #rotation-toggle.locked {
        color: #e67e22;
    }

    #gyro-toggle {
        background: rgba(52, 152, 219, 0.1);
        border: 1px solid rgba(52, 152, 219, 0.3);
        padding: 10px 14px;
        border-radius: 10px;
        color: #3498db;
        cursor: pointer;
        transition: all 0.3s ease;
        display: none;
    }

    #gyro-toggle:hover {
        color: #3498db;
        background: rgba(52,152,219,0.1);
        transform: translateY(-1px);
    }

    #gyro-toggle.active {
        color: #3498db;
        background: rgba(52,152,219,0.25);
    }

    /* Gestione Visibilit√† Intelligente per Device */
    /* Giroscopio: visibile SOLO su mobile/touch */
    body.touch #gyro-toggle,
    body.mobile #gyro-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* Full Screen: visibile SOLO su desktop */
    #fullscreen-toggle {
        display: flex;
    }

    body.touch #fullscreen-toggle,
    body.mobile #fullscreen-toggle {
        display: none;
    }

    /* Tasti pi√π grandi su mobile per facilit√† di tocco */
    body.mobile .control-btn {
        padding: 12px 16px;
        font-size: 14px;
    }

    /* GALLERY CONTROLS */
    #controls-wrapper {
        /* Galleria rimossa o nascosta */
        display: none;
    }

    /* NAVIGAZIONE */
    .nav-arrow {
        /* Frecce rimosse o nascoste */
        display: none;
    }

    /* Cursore a mano su tutti gli elementi cliccabili del progetto */
    button, .map-btn, .hover-toggle, .scene-btn, .nav-arrow, .hotspot-info, .layer-item, #layer-toggle, #map-hover-toggle, #gallery-hover-toggle, .control-btn, #bar-toggle {
        cursor: pointer;
    }

    /* Leaflet interactive shapes (marker, polylines, etc.) devono mostrare il puntatore */
    .leaflet-interactive {
        cursor: pointer !important;
    }

    /* RESPONSIVE DESIGN - MOBILE & TABLET */

    /* TABLET (max 1024px) */
    @media (max-width: 1024px) {
        #map-box {
            width: 280px;
        }

        #mapContainer {
            height: 320px;
        }

        .control-btn {
            padding: 9px 12px;
            font-size: 12px;
        }

        #scene-caption {
            font-size: 16px;
        }

        .thumb-item {
            width: 120px;
            height: 90px;
        }
    }

    /* MOBILE & TABLET (Tasti Grandi per Dita) */
    @media (max-width: 768px) {
        #top-left-controls {
            top: 10px;
            left: 10px;
            gap: 8px;
        }

        #info-widget {
            max-width: 45px;
            padding: 10px 12px;
        }

        #info-widget.active {
            max-width: calc(100vw - 80px);
        }

        #lang-toggle {
            padding: 8px 12px;
            font-size: 12px;
        }

        #map-box {
            width: 100%;
            max-width: 280px;
            top: 10px;
            right: 10px;
        }

        #mapContainer {
            height: 280px;
        }

        .map-btn {
            width: 40px;
            height: 40px;
            font-size: 20px;
        }

        #control-bar {
            padding: 10px 15px;
        }

        #bar-toggle {
            width: 44px;
            height: 44px;
            top: -45px;
            right: 15px;
        }

        .control-btn {
            padding: 11px 14px;
            font-size: 13px;
        }

        #scene-caption {
            font-size: 15px;
        }

        .thumb-item {
            width: 110px;
            height: 82px;
        }

        .hotspot-info {
            width: 54px;
            height: 54px;
            margin-left: -27px;
            margin-top: -27px;
            border-width: 4px;
        }

        .hotspot-info .hotspot-plus {
            font-size: 32px;
        }
    }

    /* MOBILE STRETTO (max 600px) */
    @media (max-width: 600px) {
        #scene-caption {
            font-size: 14px;
            padding: 0 10px;
        }

        .thumb-item {
            width: 100px;
            height: 75px;
        }
    }

    /* MOBILE PORTRAIT (max 480px) */
    @media (max-width: 480px) {
        #control-bar {
            padding: 8px 12px;
            gap: 10px;
        }

        #control-bar-top {
            flex-wrap: wrap;
            gap: 8px;
        }

        #control-bar-bottom {
            height: auto;
            min-height: 100px;
        }

        #bar-toggle {
            width: 40px;
            height: 40px;
            top: -42px;
            right: 12px;
        }

        .control-btn {
            padding: 9px 11px;
            font-size: 12px;
        }

        #scene-caption {
            font-size: 13px;
            padding: 0 8px;
        }

        .thumb-item {
            width: 90px;
            height: 67px;
        }

        #map-box {
            max-width: 240px;
        }

        #mapContainer {
            height: 240px;
        }
    }

    /* MOBILE EXTRA SMALL (max 360px) */
    @media (max-width: 360px) {
        #control-bar {
            padding: 6px 10px;
        }

        .control-btn {
            padding: 8px 10px;
            font-size: 11px;
        }

        #scene-caption {
            font-size: 12px;
        }

        .thumb-item {
            width: 80px;
            height: 60px;
        }
    }

    /* ORIENTAMENTO LANDSCAPE SU MOBILE (altezza ridotta) */
    @media (max-height: 500px) and (orientation: landscape) {
        #control-bar {
            padding: 6px 10px;
            gap: 8px;
        }

        #control-bar-bottom {
            height: auto;
            min-height: 80px;
        }

        .thumb-item {
            width: 80px;
            height: 60px;
        }

        #map-box {
            max-height: 50vh;
        }

        #mapContainer {
            height: 200px;
        }
    }
</style>
</head>
<body class="multiple-scenes view-control-buttons">

<div id="pano"></div>

<div id="top-left-controls">
    <div id="info-widget" onclick="toggleInfoTitle()">
        <span id="info-icon">‚ÑπÔ∏è</span>
        <span id="info-text">
            <div id="info-text-title">üèîÔ∏è Valle dell'Adige</div>
            <div id="info-text-content">Tour virtuale interattivo</div>
        </span>
    </div>

    <button id="lang-toggle" onclick="toggleLanguage()" title="Cambia lingua / Change language">
        <span>üåê</span> <span>IT/EN</span>
    </button>
</div>

<div id="map-box">
    <div class="map-header">
        <h3 id="map-title-text">üó∫Ô∏è Mappa Interattiva</h3>
    </div>
    <div id="mapContainer"></div>
    <div class="map-attribution" id="map-attribution"></div>
    <div class="map-controls">
        <button class="map-btn" onclick="zoomIn()" title="Zoom in">+</button>
        <button class="map-btn" onclick="zoomOut()" title="Zoom out">‚àí</button>
    </div>
    <div class="map-controls-right">
        <button id="layer-toggle" onclick="toggleLayerMenu(event)" title="Cambia mappa">
            <span>üó∫Ô∏è</span> <span id="layer-name">Strada</span>
        </button>
        <div id="layer-menu">
            <!-- Populated dynamically -->
        </div>
    </div>
</div>

<!-- Control Bar (Due livelli: superiore con controlli, inferiore con thumbnails) -->
<button id="bar-toggle" title="Mostra/Nascondi barra" aria-label="Mostra o nascondi la barra di controllo" onclick="toggleBar()">
    <svg viewBox="0 0 24 24">
        <path d="M7 10l5 5 5-5z"/>
    </svg>
</button>

<div id="control-bar">
    <div id="control-bar-top">
        <div class="control-group">
            <button id="rotation-toggle" class="control-btn" onclick="toggleRotation(event)" title="Blocca/Sblocca rotazione">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
                <span>Rotazione Auto</span>
            </button>
        </div>

        <div id="scene-caption">Valle dell'Adige</div>

        <div class="control-group">
            <button id="gyro-toggle" class="control-btn" onclick="toggleGyro()" title="Modalit√† Visore (Giroscopio)">
                <svg viewBox="0 0 24 24"><path d="M6 9l2.5-4h7l2.5 4H6zM2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6H2zm4 3a2 2 0 100 4 2 2 0 000-4zm12 0a2 2 0 100 4 2 2 0 000-4z"/></svg>
                <span>Visore VR</span>
            </button>
            <button id="fullscreen-toggle" class="control-btn" onclick="toggleFullscreen()" title="Schermo intero">
                <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                <span>Schermo Intero</span>
            </button>
        </div>
    </div>

    <div id="control-bar-bottom">
        <div class="thumb-row">
            <button class="control-btn strip-btn" onclick="document.getElementById('thumb-track').scrollBy({left: -200, behavior: 'smooth'})" title="Scorri a sinistra">
                <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
            </button>
            <div id="thumb-track">
                <!-- Thumbnails dynamically inserted here -->
            </div>
            <button class="control-btn strip-btn" onclick="document.getElementById('thumb-track').scrollBy({left: 200, behavior: 'smooth'})" title="Scorri a destra">
                <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
            </button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="vendor/screenfull.min.js"></script>
<script src="vendor/bowser.min.js"></script>
<script src="vendor/marzipano.js"></script>

<script src="data.js"></script>
<script src="data-translations.js"></script>

<script>
// === SISTEMA MULTI-LINGUA ===
var translations = {
  it: {
    loading: "Caricamento...",
    mapTitle: "üó∫Ô∏è Mappa Interattiva",
    autoRotation: "Rotazione Auto",
    gyroMode: "Visore VR",
    fullscreen: "Schermo Intero",
    prevScene: "Vista Precedente",
    nextScene: "Vista Successiva",
    showHideBar: "Mostra/Nascondi barra",
    layerStreet: "Strada",
    layerSatellite: "Satellite",
    layerTerrain: "Terreno"
  },
  en: {
    loading: "Loading...",
    mapTitle: "üó∫Ô∏è Interactive Map",
    autoRotation: "Auto Rotation",
    gyroMode: "VR Viewer",
    fullscreen: "Full Screen",
    prevScene: "Previous View",
    nextScene: "Next View",
    showHideBar: "Show/Hide bar",
    layerStreet: "Street",
    layerSatellite: "Satellite",
    layerTerrain: "Terrain"
  }
};
var currentLanguage = localStorage.getItem('tourLanguage') || 'it';

var sceneCaptions = {
    it: {
        panorama1: "Vista 1 - Valle dell'Adige",
        panorama2: "Vista 2 - Valle dell'Adige",
        panorama3: "Foce del F. Adige"
    },
    en: {
        panorama1: "View 1 - Adige Valley",
        panorama2: "View 2 - Adige Valley",
        panorama3: "Adige River Mouth"
    }
};

function getSceneCaption(sceneId) {
    if (!sceneId) return '';
    var langMap = sceneCaptions[currentLanguage] || sceneCaptions.it || {};
    return langMap[sceneId] || (sceneCaptions.it ? sceneCaptions.it[sceneId] : '') || '';
}

function refreshSceneCaption(index) {
    var captionEl = document.getElementById('scene-caption');
    if (!captionEl) return;
    var sceneData = scenes && scenes[index];
    var sceneId = sceneData && (sceneData.id || (sceneData.data && sceneData.data.id));
    if (!sceneId && window.APP_DATA && window.APP_DATA.scenes && window.APP_DATA.scenes[index]) {
        sceneId = window.APP_DATA.scenes[index].id;
    }
    captionEl.innerText = getSceneCaption(sceneId);
}

function getTranslation(key) {
  return (translations[currentLanguage] && translations[currentLanguage][key]) || translations['it'][key] || key;
}

var infoTimer = null;

function toggleInfoTitle() {
    var widget = document.getElementById('info-widget');
    if (!widget) return;
    
    if (widget.classList.contains('active')) {
        closeInfoTitle();
    } else {
        openInfoTitle(true);
    }
}

function openInfoTitle(autoClose) {
    var widget = document.getElementById('info-widget');
    if (!widget) return;

    if (infoTimer) clearTimeout(infoTimer);

    widget.classList.add('active');

    if (autoClose) {
        infoTimer = setTimeout(function() {
            closeInfoTitle();
        }, 4000);
    }
}

function closeInfoTitle() {
    var widget = document.getElementById('info-widget');
    if (widget) widget.classList.remove('active');
}

function setLanguage(lang) {
  if (!translations[lang]) return;
  currentLanguage = lang;
  localStorage.setItem('tourLanguage', lang);
  console.log('üåê Lingua cambiata a:', lang);
  
  var titleTextEl = document.getElementById('info-text-content');
  if (titleTextEl) {
    titleTextEl.innerText = lang === 'it' ? 'Tour virtuale interattivo' : 'Interactive virtual tour';
  }
  
  var rotBtn = document.getElementById('rotation-toggle');
  if (rotBtn) {
    var span = rotBtn.querySelector('span');
    if (span) span.innerText = getTranslation('autoRotation');
  }
  
  var gyroBtn = document.getElementById('gyro-toggle');
  if (gyroBtn) {
    var span = gyroBtn.querySelector('span');
    if (span) span.innerText = getTranslation('gyroMode');
  }
  
  var fullscreenBtn = document.getElementById('fullscreen-toggle');
  if (fullscreenBtn) {
    var span = fullscreenBtn.querySelector('span');
    if (span) span.innerText = getTranslation('fullscreen');
  }
  
  var barToggle = document.getElementById('bar-toggle');
  if (barToggle) {
    barToggle.title = getTranslation('showHideBar');
  }
  
  var mapTitleEl = document.getElementById('map-title-text');
  if (mapTitleEl) {
    mapTitleEl.innerText = getTranslation('mapTitle');
  }
  
  updateLayerNames();
  refreshSceneCaption(currentSceneIndex);
  
  console.log('‚úì Aggiornamenti linguistici completati');
}

function toggleLanguage() {
  var newLang = currentLanguage === 'it' ? 'en' : 'it';
  setLanguage(newLang);
}

function updateLayerNames() {
  if (layers && layers.length >= 3) {
    var items = document.querySelectorAll('.layer-item');
    if (items[0]) items[0].innerText = getTranslation('layerStreet');
    if (items[1]) items[1].innerText = getTranslation('layerSatellite');
    if (items[2]) items[2].innerText = getTranslation('layerTerrain');
  }
}

// Crea viewer
var Marzipano = window.Marzipano;
var data = window.APP_DATA;

var panoElement = document.getElementById('pano');

// Detect desktop or mobile mode.
if (window.matchMedia) {
  var setMode = function() {
    if (mql.matches) {
      document.body.classList.remove('desktop');
      document.body.classList.add('mobile');
    } else {
      document.body.classList.remove('mobile');
      document.body.classList.add('desktop');
    }
  };
  var mql = matchMedia("(max-width: 500px), (max-height: 500px)");
  setMode();
  mql.addListener(setMode);
} else {
  document.body.classList.add('desktop');
}

// Detect whether we are on a touch device.
document.body.classList.add('no-touch');
window.addEventListener('touchstart', function() {
  document.body.classList.remove('no-touch');
  document.body.classList.add('touch');
});

// Detect desktop or mobile for dynamic zoom settings
var isMobile = window.innerWidth < 768;

// Viewer options with optimized scroll zoom and speed
var viewerOpts = {
  controls: {
    mouseViewMode: data.settings.mouseViewMode,
    scrollZoom: true,           // Enable scroll zoom on desktop
    scrollZoomSpeed: 0.15,      // Much faster zoom (default ~0.05, tripled to 0.15)
    touchViewMode: 'drag'       // Keep drag smooth on mobile
  }
};

// Initialize viewer.
var viewer = new Marzipano.Viewer(panoElement, viewerOpts);

// Create scenes.
var scenes = data.scenes.map(function(data) {
  var urlPrefix = "tiles";
  var source = Marzipano.ImageUrlSource.fromString(
    urlPrefix + "/" + data.id + "/{z}/{f}/{y}/{x}.jpg",
    { cubeMapPreviewUrl: urlPrefix + "/" + data.id + "/preview.jpg" });
  var geometry = new Marzipano.CubeGeometry(data.levels);

  // Dynamic zoom limits: optimized for quality and range
  // minFov controls how much you can zoom IN (lower = more zoom)
  // maxFov controls how much you can zoom OUT (wider view)
  // Using 4096 as theoretical max resolution (not faceSize) to prevent pixelation when zooming
  var fovMinDeg = isMobile ? 30 : 15;    // Desktop: 15¬∞ (good zoom), Mobile: 30¬∞ (safe for touch)
  var fovMaxDeg = isMobile ? 100 : 120;  // Desktop: 120¬∞ (ultra-wide), Mobile: 100¬∞ (no tunnel effect)
  
  var minFov = fovMinDeg * Math.PI / 180;
  var maxFov = fovMaxDeg * Math.PI / 180;
  
  // Use 4096 as theoretical max resolution for quality preservation
  var limiter = Marzipano.RectilinearView.limit.traditional(4096, minFov, maxFov);
  
  // Set initial view at 85¬∞ for cinematic feel (slightly more zoomed than default 90¬∞)
  var initialView = Object.assign({}, data.initialViewParameters);
  if (!initialView.fov) {
    initialView.fov = 85 * Math.PI / 180;  // 85¬∞ initial FOV
  }
  
  var view = new Marzipano.RectilinearView(initialView, limiter);

  var scene = viewer.createScene({
    source: source,
    geometry: geometry,
    view: view,
    pinFirstLevel: true,
    textureStoreOpts: {
      // Increase cache to prevent texture disappearing when rotating while zoomed
      previouslyVisibleCacheSize: 100
    }
  });

  // Create link hotspots.
  data.linkHotspots.forEach(function(hotspot) {
    var element = createLinkHotspotElement(hotspot);
    scene.hotspotContainer().createHotspot(element, { yaw: hotspot.yaw, pitch: hotspot.pitch });
  });

  // Create info hotspots.
  data.infoHotspots.forEach(function(hotspot) {
    var element = createInfoHotspotElement(hotspot);
    scene.hotspotContainer().createHotspot(element, { yaw: hotspot.yaw, pitch: hotspot.pitch });
  });

  return {
    data: data,
    scene: scene,
    view: view
  };
});

var currentSceneIndex = 0;
var currentView, map, markers = [];
var baseLayer, satelliteLayer, cartoLayer, layers = [], currentLayerIndex = 0;
var rotationLocked = false;
var rotationTimer = null;
var rotationLockMode = null;
var gyroEnabled = false;
var isDeviceMobile = false;

// Set up autorotate, if enabled.
var autorotate = Marzipano.autorotate({
  yawSpeed: 0.03,
  targetPitch: 0,
  targetFov: Math.PI/2
});

function detectDeviceType() {
    var ua = navigator.userAgent;
    var isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
    var isTablet = /iPad|Android(?!.*Mobile)/i.test(ua);
    var hasTouch = function() {
        return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    };
    
    isDeviceMobile = isMobile || hasTouch();
    
    var classList = document.body.classList;
    if (hasTouch()) classList.add('touch');
    if (isMobile || isTablet) classList.add('mobile');
    
    console.log('üì± Device Type Detected:', { isMobile: isMobile, isTablet: isTablet, hasTouch: hasTouch(), isDeviceMobile: isDeviceMobile });
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', detectDeviceType);
} else {
    detectDeviceType();
}

function toggleGyro() {
    var btn = document.getElementById('gyro-toggle');
    if (!btn) return;
    
    if (typeof DeviceOrientationEvent === 'undefined') {
        alert('Il tuo dispositivo non supporta il giroscopio');
        return;
    }
    
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(function(permissionState) {
                if (permissionState === 'granted') {
                    activateGyroLogic(btn);
                }
            })
            .catch(console.error);
    } else {
        activateGyroLogic(btn);
    }
}

function activateGyroLogic(btn) {
    gyroEnabled = !gyroEnabled;
    
    var svgGyroOff = '<svg viewBox="0 0 24 24"><path d="M6 9l2.5-4h7l2.5 4H6zM2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6H2zm4 3a2 2 0 100 4 2 2 0 000-4zm12 0a2 2 0 100 4 2 2 0 000-4z" /></svg>';
    var svgGyroOn = '<svg viewBox="0 0 24 24"><path d="M2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6H2zm4 3a2 2 0 100 4 2 2 0 000-4zm12 0a2 2 0 100 4 2 2 0 000-4z" fill="currentColor" stroke="none"/></svg>';
    
    if (gyroEnabled) {
        btn.classList.add('active');
        btn.innerHTML = svgGyroOn + '<span>' + getTranslation('gyroMode') + '</span>';
        
        if (typeof DeviceOrientationEvent !== 'undefined') {
            window.addEventListener('deviceorientation', handleDeviceOrientation, true);
        }
        
        viewer.controls().disable();
        stopAutoRotation();
    } else {
        btn.classList.remove('active');
        btn.innerHTML = svgGyroOff + '<span>' + getTranslation('gyroMode') + '</span>';
        
        if (typeof DeviceOrientationEvent !== 'undefined') {
            window.removeEventListener('deviceorientation', handleDeviceOrientation, true);
        }
        
        viewer.controls().enable();
        if (!rotationLocked) {
            startAutoRotation();
        }
    }
}

function handleDeviceOrientation(event) {
    if (!gyroEnabled || !viewer || !currentView) return;
    
    try {
        var alpha = event.alpha;
        var beta = event.beta;
        var gamma = event.gamma;
        
        if (alpha !== null && beta !== null && gamma !== null) {
            var yaw = alpha * Math.PI / 180;
            var pitch = (beta - 90) * Math.PI / 180;
            
            pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
            
            currentView.setYaw(yaw);
            currentView.setPitch(pitch);
        }
    } catch(e) {
        console.error('Gyro error:', e);
    }
}

function createLinkHotspotElement(hotspot) {
  var wrapper = document.createElement('div');
  wrapper.classList.add('hotspot');
  wrapper.classList.add('link-hotspot');

  var icon = document.createElement('img');
  icon.src = 'img/link.png';
  icon.classList.add('link-hotspot-icon');

  var transformProperties = [ '-ms-transform', '-webkit-transform', 'transform' ];
  for (var i = 0; i < transformProperties.length; i++) {
    var property = transformProperties[i];
    icon.style[property] = 'rotate(' + hotspot.rotation + 'rad)';
  }

  wrapper.addEventListener('click', function() {
    switchScene(findSceneById(hotspot.target));
  });

  stopTouchAndScrollEventPropagation(wrapper);

  var tooltip = document.createElement('div');
  tooltip.classList.add('link-hotspot-tooltip');
  tooltip.classList.add('link-hotspot-tooltip-visible');
  var targetScene = findSceneDataById(hotspot.target);
  tooltip.innerHTML = targetScene ? targetScene.name : '';

  wrapper.appendChild(icon);
  wrapper.appendChild(tooltip);

  return wrapper;
}

function createInfoHotspotElement(hotspot) {
  var wrapper = document.createElement('div');
  wrapper.classList.add('hotspot-info');

  var plus = document.createElement('div');
  plus.classList.add('hotspot-plus');
  plus.innerHTML = '+';
  wrapper.appendChild(plus);

  wrapper.addEventListener('click', function(e) {
    e.stopPropagation();
    showInfoHotspot(hotspot.title, hotspot.text, hotspot.image);
  });

  stopTouchAndScrollEventPropagation(wrapper);

  return wrapper;
}

function showInfoHotspot(title, text, imageUrl) {
  var existing = document.getElementById('info-hotspot-modal');
  if (existing) existing.remove();

  var modal = document.createElement('div');
  modal.id = 'info-hotspot-modal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.3s ease;';

  var content = document.createElement('div');
  content.style.cssText = 'background:linear-gradient(145deg, #1a1a1a, #2d2d2d);max-width:600px;width:100%;border-radius:16px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.8);animation:slideUp 0.4s ease;';

  var header = document.createElement('div');
  header.style.cssText = 'background:linear-gradient(135deg, #3498db, #2980b9);padding:20px;display:flex;justify-content:space-between;align-items:center;';

  var titleEl = document.createElement('h3');
  titleEl.style.cssText = 'color:white;font-size:20px;font-weight:600;margin:0;';
  titleEl.innerText = title;

  var closeBtn = document.createElement('button');
  closeBtn.innerHTML = '√ó';
  closeBtn.style.cssText = 'background:none;border:none;color:white;font-size:32px;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.3s;';
  closeBtn.onmouseover = function() { this.style.background = 'rgba(255,255,255,0.2)'; };
  closeBtn.onmouseout = function() { this.style.background = 'none'; };
  closeBtn.onclick = hideInfoHotspot;

  header.appendChild(titleEl);
  header.appendChild(closeBtn);

  var body = document.createElement('div');
  body.style.cssText = 'padding:24px;max-height:70vh;overflow-y:auto;';

  if (imageUrl) {
    var img = document.createElement('img');
    img.src = imageUrl;
    img.style.cssText = 'width:100%;height:auto;border-radius:12px;margin-bottom:20px;box-shadow:0 8px 24px rgba(0,0,0,0.4);';
    img.onerror = function() { this.style.display = 'none'; };
    body.appendChild(img);
  }

  var textEl = document.createElement('p');
  textEl.style.cssText = 'color:#ddd;font-size:15px;line-height:1.8;margin:0;';
  textEl.innerHTML = text;
  body.appendChild(textEl);

  content.appendChild(header);
  content.appendChild(body);
  modal.appendChild(content);
  document.body.appendChild(modal);

  modal.addEventListener('click', function(e) {
    if (e.target === modal) hideInfoHotspot();
  });

  var style = document.createElement('style');
  style.innerHTML = '@keyframes fadeIn { from { opacity:0; } to { opacity:1; } } @keyframes slideUp { from { transform:translateY(30px); opacity:0; } to { transform:translateY(0); opacity:1; } }';
  document.head.appendChild(style);
}

function hideInfoHotspot() {
  var modal = document.getElementById('info-hotspot-modal');
  if (modal) modal.remove();
}

function stopTouchAndScrollEventPropagation(element) {
  var eventList = [
    'touchstart', 'touchmove', 'touchend', 'touchcancel',
    'pointerdown', 'pointermove', 'pointerup', 'pointercancel',
    'wheel'
  ];
  for (var i = 0; i < eventList.length; i++) {
    element.addEventListener(eventList[i], function(event) {
      event.stopPropagation();
    });
  }
}

function findSceneById(id) {
  for (var i = 0; i < scenes.length; i++) {
    if (scenes[i].data.id === id) {
      return scenes[i];
    }
  }
  return null;
}

function findSceneDataById(id) {
  for (var i = 0; i < data.scenes.length; i++) {
    if (data.scenes[i].id === id) {
      return data.scenes[i];
    }
  }
  return null;
}

function findSceneIndexById(id) {
  for (var i = 0; i < scenes.length; i++) {
    if (scenes[i].data.id === id) {
      return i;
    }
  }
  return 0;
}

function switchScene(scene) {
  if (!scene) return;
  
  stopAutoRotation();
  scene.view.setParameters(scene.data.initialViewParameters);
  scene.scene.switchTo();
  
  currentSceneIndex = findSceneIndexById(scene.data.id);
  currentView = scene.view;
  
  if (!rotationLocked) {
    startAutoRotation();
  }
  
  updateThumbnails();
  refreshSceneCaption(currentSceneIndex);
  updateMapMarker();
}

function startAutoRotation() {
  if (data.settings.autorotateEnabled && !rotationLocked && !gyroEnabled) {
    viewer.startMovement(autorotate);
    viewer.setIdleMovement(3000, autorotate);
  }
}

function stopAutoRotation() {
  viewer.stopMovement();
  viewer.setIdleMovement(Infinity);
}

function toggleRotation(e) {
  if (e) e.stopPropagation();
  
  rotationLocked = !rotationLocked;
  
  if (rotationLocked) {
    rotationLockMode = 'manual';
    stopAutoRotation();
  } else {
    rotationLockMode = null;
    if (rotationTimer) clearTimeout(rotationTimer);
    startAutoRotation();
  }
  
  updateRotationButton();
}

function updateRotationButton() {
  var btn = document.getElementById('rotation-toggle');
  if (!btn) return;
  
  if (rotationLocked) {
    btn.classList.add('locked');
    btn.title = currentLanguage === 'it' ? 'Rotazione bloccata (clicca per sbloccare)' : 'Rotation locked (click to unlock)';
  } else {
    btn.classList.remove('locked');
    btn.title = currentLanguage === 'it' ? 'Rotazione automatica attiva (clicca per bloccare)' : 'Auto-rotation active (click to lock)';
  }
}

function toggleFullscreen() {
  if (document.fullscreenElement || document.webkitFullscreenElement) {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    }
  } else {
    if (document.body.requestFullscreen) {
      document.body.requestFullscreen();
    } else if (document.body.webkitRequestFullscreen) {
      document.body.webkitRequestFullscreen();
    }
  }
}

function toggleBar() {
  var bar = document.getElementById('control-bar');
  var btn = document.getElementById('bar-toggle');
  if (!bar || !btn) return;
  
  bar.classList.toggle('collapsed');
  btn.classList.toggle('collapsed');
}

function updateThumbnails() {
  var track = document.getElementById('thumb-track');
  if (!track) return;
  
  track.innerHTML = '';
  
  scenes.forEach(function(sceneObj, index) {
    var thumb = document.createElement('div');
    thumb.classList.add('thumb-item');
    if (index === currentSceneIndex) {
      thumb.classList.add('active');
    }
    
    var img = document.createElement('img');
    img.src = 'tiles/' + sceneObj.data.id + '/preview.jpg';
    img.alt = sceneObj.data.name;
    
    thumb.appendChild(img);
    thumb.onclick = function() {
      switchScene(sceneObj);
    };
    
    track.appendChild(thumb);
  });
}

// MAPPA LEAFLET
async function initMap() {
  if (typeof L === 'undefined') {
    console.warn('Leaflet non caricato');
    return;
  }
  
  var coords = window.APP_DATA && window.APP_DATA.coordinates;
  if (!coords || coords.length === 0) {
    coords = [
      { lat: 45.2213333333333, lng: 11.2943416666667 },
      { lat: 45.2208555555556, lng: 11.2942472222222 },
      { lat: 45.1443555555556, lng: 12.300925 }
    ];
  }
  
  map = L.map('mapContainer', {
    zoomControl: false,
    attributionControl: false
  }).setView([coords[0].lat, coords[0].lng], 13);
  
  baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
  satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
  cartoLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png');
  
  layers = [baseLayer, satelliteLayer, cartoLayer];
  currentLayerIndex = 0;
  layers[currentLayerIndex].addTo(map);
  
  coords.forEach(function(coord, i) {
    var marker = L.circleMarker([coord.lat, coord.lng], {
      radius: 8,
      fillColor: i === 0 ? '#3498db' : '#95a5a6',
      color: '#fff',
      weight: 2,
      opacity: 1,
      fillOpacity: 0.8
    }).addTo(map);
    
    marker.on('click', function() {
      switchScene(scenes[i]);
    });
    
    markers.push(marker);
  });
  
  buildLayerMenu();
  updateLayerNames();
}

function updateMapMarker() {
  if (!map || !markers || markers.length === 0) return;
  
  markers.forEach(function(marker, i) {
    marker.setStyle({
      fillColor: i === currentSceneIndex ? '#3498db' : '#95a5a6',
      radius: i === currentSceneIndex ? 10 : 8
    });
  });
}

function zoomIn() {
  if (map) map.zoomIn();
}

function zoomOut() {
  if (map) map.zoomOut();
}

function setLayer(index) {
  if (!map || !layers || index < 0 || index >= layers.length) return;
  
  map.removeLayer(layers[currentLayerIndex]);
  currentLayerIndex = index;
  map.addLayer(layers[currentLayerIndex]);
  
  var layerNames = [getTranslation('layerStreet'), getTranslation('layerSatellite'), getTranslation('layerTerrain')];
  var nameEl = document.getElementById('layer-name');
  if (nameEl) nameEl.innerText = layerNames[index];
  
  var items = document.querySelectorAll('.layer-item');
  items.forEach(function(item, i) {
    if (i === index) {
      item.classList.add('active');
    } else {
      item.classList.remove('active');
    }
  });
  
  hideLayerMenu();
}

function toggleLayerMenu(e) {
  if (e) e.stopPropagation();
  var menu = document.getElementById('layer-menu');
  if (menu) menu.classList.toggle('visible');
}

function hideLayerMenu() {
  var menu = document.getElementById('layer-menu');
  if (menu) menu.classList.remove('visible');
}

function buildLayerMenu() {
  var menu = document.getElementById('layer-menu');
  if (!menu) return;
  
  var layerNames = [getTranslation('layerStreet'), getTranslation('layerSatellite'), getTranslation('layerTerrain')];
  
  menu.innerHTML = '';
  layerNames.forEach(function(name, i) {
    var item = document.createElement('div');
    item.classList.add('layer-item');
    if (i === currentLayerIndex) item.classList.add('active');
    item.innerText = name;
    item.onclick = function() { setLayer(i); };
    menu.appendChild(item);
  });
}

document.addEventListener('click', function(e) { hideLayerMenu(); });
document.addEventListener('touchstart', function(e) { hideLayerMenu(); });

function init() {
  // Display the initial scene.
  switchScene(scenes[0]);
  updateThumbnails();
  initMap();
  setLanguage(currentLanguage);
  
  console.log('‚úÖ Tour inizializzato');
}

// Avvia l'app quando il DOM √® pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
</script>

</body>
</html>
