<!DOCTYPE html>
<html lang="it">
<head>
    <title>Tour 360 Pro - Valle dell'Adige</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <!-- Preconnect ai CDN per velocizzare il caricamento -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>
    <link rel="dns-prefetch" href="https://server.arcgisonline.com" />
    <link rel="dns-prefetch" href="https://basemaps.cartocdn.com" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --danger: #e74c3c;
            --bg-glass: rgba(44, 62, 80, 0.9);
            --thumb-size: 88px;
            --thumb-gap: 8px;
            --bar-height: 132px;
            --thumb-count: 3;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #000; overflow: hidden; height: 100vh; touch-action: manipulation; }
        /* Ottimizza touch per mobile - touch-action: manipulation permette pinch-to-zoom di Marzipano */
    #pano {
      position: absolute;
      width: 100%;
      height: 100%;
      cursor: grab;
      touch-action: pan-x pan-y;
      transition: opacity 0.8s ease;
    }
    #pano:active {
      cursor: grabbing;
    }

                /* --- CONTENITORE COMUNE TOP-LEFT --- */
                #top-left-controls {
                    position: absolute;
                    top: 20px;
                    left: 20px;
                    z-index: 1100; /* Sopra a tutto */
                    display: flex;
                    flex-direction: column; /* Impila Info sopra Lingua */
                    gap: 12px; /* Spazio tra i due pulsanti */
                    align-items: flex-start; /* Allinea tutto a sinistra */
                    pointer-events: none; /* Lascia passare i click negli spazi vuoti */
                }

                /* --- WIDGET INFO (Pulsante + Testo) --- */
                #info-widget {
                    display: flex;
                    align-items: center;
                    pointer-events: auto; /* Riabilita click */
                    gap: 0; /* Gap gestito dall'espansione */
                    height: 40px;
                }

                /* Pulsante "i" Rotondo */
                #info-toggle {
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    background: rgba(0, 0, 0, 0.6);
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    color: #fff;
                    font-family: 'Segoe UI', sans-serif;
                    font-weight: 700;
                    font-size: 18px;
                    font-style: italic; /* La "i" corsiva è elegante */
                    cursor: pointer;
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                    z-index: 2; /* Sta sopra al testo che si srotola */
                    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                }

                #info-toggle:hover {
                    background: #3498db;
                    border-color: #3498db;
                    transform: scale(1.05);
                }

                /* Contenitore del testo che si srotola */
                #info-label {
                    background: rgba(0, 0, 0, 0.6);
                    backdrop-filter: blur(10px);
                    -webkit-backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.15);
                    border-left: none; /* Unito visivamente al bottone */
                    height: 36px; /* Leggermente più piccolo del bottone per estetica */
                    display: flex;
                    align-items: center;
                    overflow: hidden;
                    
                    /* ANIMAZIONE SROTOLAMENTO */
                    max-width: 0; /* Chiuso di default */
                    opacity: 0;
                    padding: 0;
                    margin-left: -20px; /* Nascosto sotto il bottone */
                    border-radius: 0 20px 20px 0; /* Arrotondato solo a destra */
                    
                    transition: max-width 0.6s cubic-bezier(0.25, 1, 0.5, 1), 
                                opacity 0.4s ease, 
                                padding 0.4s ease, 
                                margin-left 0.4s ease;
                }

                /* STATO APERTO (Classe aggiunta via JS) */
                #info-widget.active #info-label {
                    max-width: 400px; /* Larghezza massima sufficiente per il titolo */
                    opacity: 1;
                    padding: 0 20px 0 25px; /* Padding a sinistra extra per staccarsi dal bottone */
                    margin-left: -10px; /* Si sposta fuori dal bottone */
                }

                /* Testo interno */
                #info-text-content {
                    color: #fff;
                    white-space: nowrap;
                    font-size: 13px;
                    font-weight: 600;
                    letter-spacing: 1px;
                    text-transform: uppercase;
                }

                /* --- ADATTAMENTO LINGUA BUTTON --- */
                /* (Rimuoviamo posizionamento assoluto perché ora è nel flex container) */
                #lang-toggle {
                    position: static !important; /* Reset position */
                    pointer-events: auto;
                    margin-left: 2px; /* Allineamento ottico col bottone info */
                }

        #pano.fade-in { animation: panoFade 0.8s ease; }
        @keyframes panoFade { from { opacity: 0.45; } to { opacity: 1; } }


        #lang-toggle:hover {
            background: rgba(52, 152, 219, 0.3);
            border-color: rgba(52, 152, 219, 0.5);
            transform: translateY(-1px);
        }
        #lang-toggle.active {
            background: rgba(52, 152, 219, 0.5);
            border-color: rgba(52, 152, 219, 0.8);
        }
        #lang-toggle .lang-it,
        #lang-toggle .lang-en {
            transition: all 0.2s ease;
            padding: 2px 4px;
            border-radius: 4px;
        }
        #lang-toggle .lang-it.active {
            font-weight: bold;
            color: #fff;
            background: rgba(52, 152, 219, 0.7);
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 12px rgba(52, 152, 219, 0.8);
        }
        #lang-toggle .lang-en.active {
            font-weight: bold;
            color: #fff;
            background: rgba(52, 152, 219, 0.7);
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 12px rgba(52, 152, 219, 0.8);
        }

        #lang-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            right: auto;
            z-index: 1001;
            background: rgba(0,0,0,0.55);
            color: #fff;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.14);
            backdrop-filter: blur(10px);
            font-size: 11px;
            transition: all 0.2s ease;
        }

        /* --- MAP BOX --- */
        #map-box {
            position: absolute; top: 20px; right: 20px; /* Alzata per liberare centro */
            width: 320px; height: 260px; 
            min-width: 280px; min-height: 220px; /* Evita sovrapposizione tasti */
            z-index: 1001;
            border-radius: 14px; overflow: hidden; box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            transition: transform 0.15s ease, opacity 0.15s ease; border: 1px solid rgba(255,255,255,0.2);
            background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            pointer-events: auto;
        }
        #map-box.collapsed { width: 56px; height: 56px; border-radius: 50%; transform: scale(0.95); border: none; box-shadow: 0 0 0 transparent; background: transparent; pointer-events: none; }
        /* Quando la mappa è contratta mostriamo solo il bottone di espandi/contrai */
        #map-box.collapsed .map-header,
        #map-box.collapsed .map-attribution,
        #map-box.collapsed .map-controls-right,
        #map-box.collapsed .map-controls,
        #map-box.collapsed #mapContainer {
            display: none !important;
        }
        /* Rendiamo il bottone di expand pienamente visibile e centrato nel box */
        #map-box.collapsed #map-hover-toggle {
            display: flex; width: 56px; height: 56px; border-radius: 50%;
            inset: 0; margin: auto; align-items: center; justify-content: center;
            background: linear-gradient(180deg, #2a2a2a, #0f0f0f); border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 10px 24px rgba(0,0,0,0.55);
            cursor: pointer; pointer-events: auto; /* Permette il clic per espandere la mappa */
        }
        #mapContainer { width: 100%; height: calc(100% - 36px); }
        #map-toggle {
            position: absolute; bottom: 8px; right: 8px; z-index: 1002;
            width: 34px; height: 34px; border-radius: 8px; border: none;
            background: rgba(0,0,0,0.4); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        /* hover toggle (mostra solo al passaggio del mouse) */
        .hover-toggle {
            position: absolute; bottom: 15px; right: 8px; z-index: 1004;
            width: 34px; height: 34px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06);
            background: rgba(0,0,0,0.45); color: #fff; display: flex; align-items: center; justify-content: center;
            opacity: 1; pointer-events: auto; transition: opacity 0.1s ease, transform 0.1s ease;
        }
        #map-box:hover .hover-toggle { transform: translateY(0); }
        #controls-wrapper:hover .hover-toggle { transform: translateY(0); }
        .map-attribution {
            position: absolute; bottom: 8px; left: 10px; z-index: 1002; color: #bbb;
            font-size: 11px; background: rgba(0,0,0,0.25); padding: 4px 8px; border-radius: 6px;
            backdrop-filter: blur(4px);
        }
        .map-header {
            height: 36px; display: flex; align-items: center; justify-content: space-between;
            padding: 6px 10px; gap: 8px; z-index: 1003; backdrop-filter: blur(6px);
        }
        /* Stile testi testata mappa (Grassetto e Leggibile) */
        .map-title { 
            color: #ffffff !important; 
            font-size: 13px !important; 
            font-weight: 800 !important;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .map-layer-name { 
            color: #ffffff !important; 
            font-size: 11px !important; 
            font-weight: 700 !important;
            background: rgba(52, 152, 219, 0.6) !important;
            padding: 2px 8px !important;
            border-radius: 4px !important;
            opacity: 1 !important;
            margin-left: 4px !important;
        }
        #map-coordinates {
            display: inline-block;
            font-size: 11px !important;
            color: #ffffff !important;
            font-weight: 700 !important;
            margin-left: 10px !important;
            text-shadow: 1px 1px 3px rgba(0,0,0,1);
            font-family: monospace !important;
            background: none !important;
            backdrop-filter: none !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            position: static !important;
            pointer-events: none;
        }
        /* layer menu */
        .layer-menu {
            position: absolute; top: 44px; right: 10px; z-index: 1005;
            background: rgba(10,10,10,0.95); color: #fff; border-radius: 8px; padding: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6); min-width: 140px; display: none;
        }
        /* Nascondi il menu layer: ora usiamo modalità 'cycle' via pulsante */
        .layer-menu { display: none !important; }
        .layer-menu.show { display: block; animation: fadeIn 160ms ease; }
        .layer-item { display: flex; gap: 8px; align-items: center; padding: 8px 10px; cursor: pointer; border-radius: 6px; }
        .layer-item:hover { background: rgba(255,255,255,0.03); }
        .layer-item.active { background: rgba(255,255,255,0.04); font-weight: 700; }
        @keyframes fadeIn { from { transform: translateY(-6px); opacity: 0 } to { transform: translateY(0); opacity: 1 } }

        /* pulsate animation for layer button when layer changes */
        .pulse {
            animation: pulse-scale 360ms ease;
        }
        @keyframes pulse-scale { 0% { transform: scale(1); } 50% { transform: scale(1.08); } 100% { transform: scale(1); } }
        
        /* --- MAP CONTROLS --- */
        .map-controls {
            position: absolute; top: 44px; left: 10px; z-index: 1002;
            display: flex; flex-direction: column; gap: 8px;
        }
        .map-controls-right {
            position: absolute; top: 44px; right: 10px; z-index: 1003;
            display: flex; flex-direction: column; gap: 8px; align-items: flex-end;
        }
        #map-box.collapsed .map-controls { display: none; }
        .map-btn {
            width: 38px; height: 38px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.06);
            background: rgba(0,0,0,0.45); color: #fff; cursor: pointer;
            font-size: 16px; font-weight: 700;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: transform 0.08s ease, background 0.08s ease;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .map-btn:hover { background: rgba(255,255,255,0.06); transform: translateY(-2px); }
        #layer-toggle {
            font-size: 16px; padding: 6px; width: 42px; height: 36px; border-radius: 8px;
            /* Pulsante in tono grigio/nero */
            background: linear-gradient(180deg, #2a2a2a, #0f0f0f);
            color: #f2f2f2; border: 1px solid rgba(255,255,255,0.04);
            cursor: pointer; font-weight: 700; display: inline-flex; align-items: center; justify-content: center;
        }

#layer-toggle:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.6); }
#layer-toggle:focus { outline: 3px solid rgba(255,255,255,0.06); }

        /* --- HOTSPOT NATIVO (CENTRATO) --- */
        .hotspot-info {
            width: 34px; height: 34px;
            background: rgba(52, 152, 219, 0.25);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(52, 152, 219, 0.5);
            border-radius: 50%;
            cursor: pointer;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            z-index: 10010;
            /* Forza la centratura rispetto al punto di aggancio di Marzipano */
            position: absolute;
            margin-top: -17px; 
            margin-left: -17px;
            transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2), 0 4px 15px rgba(0,0,0,0.3); /* Doppio layer per massima visibilità */
            animation: pulse-white 2s infinite;
        }
        .hotspot-info:hover { transform: scale(1.08); box-shadow: 0 12px 26px rgba(52, 152, 219, 0.5); background: rgba(52, 152, 219, 0.4); }
        .hotspot-info .hotspot-plus {
            font-size: 18px; line-height: 1; display:flex; align-items:center; justify-content:center;
            width: 100%; height: 100%; margin: 0; padding: 0;
        }

        @keyframes pulse-white {
            0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(52, 152, 219, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
        }

        /* --- CONTROL BAR (BARRA A DUE LIVELLI) --- */
        #control-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(0);
            width: min(94vw, calc(var(--thumb-count) * (var(--thumb-size) + var(--thumb-gap)) + 260px));
            max-width: 1000px;
            height: auto;
            min-height: var(--bar-height);
            background: rgba(15, 15, 15, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            overflow: visible;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, bottom 0.3s ease;
            opacity: 1;
        }
        
        /* --- ICONE SVG ELEGANTI --- */
        .control-btn svg, 
        #bar-toggle svg {
            width: 24px;   /* Dimensione standard icona */
            height: 24px;
            fill: none;    /* Niente riempimento pieno */
            stroke: #ffffff; /* Linea BIANCA elegante */
            stroke-width: 2; /* Spessore linea moderno */
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); /* Ombra leggera per contrasto */
            transition: all 0.2s ease;
        }

        /* Hover effect */
        .control-btn:hover svg,
        #bar-toggle:hover svg {
            stroke: #3498db; /* Azzurro al passaggio mouse */
            transform: scale(1.1);
        }

        /* Su mobile le icone devono essere leggermente più grandi */
        @media (max-width: 768px) {
            .control-btn svg,
            #bar-toggle svg {
                width: 28px;
                height: 28px;
            }
        }
        
        #control-bar.collapsed {
            transform: translateX(-50%) translateY(100%);
            opacity: 0;
            pointer-events: none;
        }
        
        #bar-toggle {
            transition: all 0.3s ease;
        }
        
        #bar-toggle.collapsed {
            bottom: 60px;
        }

        
        #control-bar.collapsed #control-bar-top,
        #control-bar.collapsed #control-bar-bottom {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Mantieni visibile e cliccabile il bottone gallery-toggle-bar per riaprire */
        #controls-wrapper.collapsed #gallery-toggle-bar {
            opacity: 1 !important;
            pointer-events: auto !important;
            position: absolute;
            left: 0;
            top: 12px;
            z-index: 1005;
            display: flex !important;
            align-items: center;
            justify-content: center;
        }
        
        #control-bar.collapsed::after {
            content: "⏴  ⏵"; /* Frecce orizzontali sullo stesso livello */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            letter-spacing: 8px; /* Spazio tra le frecce */
            white-space: nowrap;
            pointer-events: none;
        }

        /* --- TOGGLE BUTTON (espansione orizzontale) - posizionato a destra del titolo --- */
        #bar-toggle {
            position: fixed;
            right: 20px;
            bottom: calc(var(--bar-height) + 45px);
            width: 44px;
            height: 44px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0, 0, 0, 0.5);
            color: #f2f2f2;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            transform: none;
            left: auto;
        }
        
        #bar-toggle:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
        }
        
        #bar-toggle.collapsed {
            bottom: calc(var(--bar-height) + 45px);
            right: 20px;
        }

        /* --- TOP ROW --- */
        #control-bar-top {
            display: flex;
            flex-wrap: nowrap !important; /* FORZA UNA SOLA RIGA: Impedisce di andare a capo */
            align-items: center;
            justify-content: space-between;
            min-height: 50px;
            padding: 6px 15px;
            padding-right: 60px; /* Spazio per bar-toggle a destra */
            gap: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            overflow: hidden; /* Assicura che nulla esca dal contenitore */
        }

        /* I gruppi laterali non occupano spazio extra, così la didascalia può allargarsi */
        #control-bar-top .control-group:first-of-type,
        #control-bar-top .control-group:last-of-type {
            flex: 0 0 auto;
        }
        #control-bar-top .control-group:last-of-type { justify-content: flex-end; }

        /* Impedisci ai bottoni di comprimersi quando lo spazio è poco */
        #control-bar-top .control-group:last-of-type {
            flex-wrap: nowrap;
            row-gap: 6px;
        }
        #control-bar-top .control-group .control-btn {
            flex: 0 0 auto;
        }

        /* Impedisci ai gruppi di bottoni di schiacciarsi */
        .control-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0 !important; /* IMPORTANTE: I bottoni non devono mai restringersi */
        }

        /* --- BOTTOM ROW (118px) --- */
        #control-bar-bottom {
            height: calc(var(--thumb-size) + 0px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 12px 8px;
            gap: 6px;
        }
        /* Gestione testo centrale con i puntini (...) */
        #scene-caption {
            color: #ffffff !important;
            font-size: 13px !important; /* Leggermente più grande per leggibilità */
            font-weight: 500 !important;
            text-align: center;
            padding: 0 8px !important;
            
            /* REGOLE PER I PUNTINI (...) */
            white-space: nowrap !important;  /* Testo su una sola riga */
            overflow: hidden !important;     /* Nascondi l'eccedenza */
            text-overflow: ellipsis !important; /* Aggiungi i tre puntini */
            
            flex: 1; /* Occupa tutto lo spazio disponibile tra i due gruppi di bottoni */
            min-width: 0; /* TRUCCO FLEXBOX: Permette al contenitore di rimpicciolirsi sotto la larghezza del testo */
            
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin: 0;
            background: transparent;
            border: none;
            box-shadow: none;
        }
        .thumb-row {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--thumb-gap);
        }
        /* --- THUMBNAILS STRIP --- */
        #thumb-track {
            flex: 1 1 auto;
            display: flex;
            gap: var(--thumb-gap);
            justify-content: center;
            align-items: center;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 4px 0;
            height: var(--thumb-size);
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        #thumb-track::-webkit-scrollbar { display: none; }
        
        .thumb-item {
            flex: 0 0 var(--thumb-size);
            height: var(--thumb-size);
            min-width: var(--thumb-size);
            border-radius: 4px;
            cursor: pointer;
            border: 3px solid transparent;
            overflow: hidden;
            transition: all 0.15s ease;
            position: relative;
            background: #222; /* Colore di sfondo mentre carica l'immagine per evitare sfarfallio */
        }
        .thumb-item::after {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0) 55%, rgba(0,0,0,0.45) 100%);
            pointer-events: none;
        }
        .thumb-item img { width: 100%; height: 100%; object-fit: cover; object-position: center 40%; }
        /* Stile base miniatura attiva: bordo bianco + pulsazione */
        .thumb-item.active {
            border-color: #ffffff !important;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
            transform: scale(1.05);
            animation: thumb-pulse 2s infinite;
            z-index: 10;
        }
        /* Animazione di pulsazione (simile all'hotspot) */
        @keyframes thumb-pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        /* Effetto hover migliorato */
        .thumb-item:hover {
            transform: scale(1.08);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* --- CONTROL BUTTONS --- */
        .control-btn {
            flex: 0 0 auto;
            height: 44px;
            min-width: 44px;
            padding: 0 12px;
            border: none;
            background: transparent;
            color: #f2f2f2;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border-radius: 8px;
            transition: transform 0.12s ease, color 0.12s ease, background 0.12s ease;
            cursor: pointer;
        }
        .control-btn:hover { color: #67b6ff; transform: translateY(-1px); background: rgba(255,255,255,0.06); }
        .control-btn:active { transform: translateY(0); }
        .control-btn svg { width: 18px; height: 18px; fill: currentColor; }
        .strip-btn svg { width: 18px; height: 18px; fill: currentColor; }

        /* Pulsante rotazione minimal */
        #rotation-toggle {
            border: none;
            background: transparent;
            color: #f2f2f2;
            font-size: 18px;
            padding: 0 10px;
            min-width: 44px;
            height: 44px;
            border-radius: 8px;
            transition: color 0.12s ease, background 0.12s ease, transform 0.12s ease;
            cursor: pointer;
        }
        #rotation-toggle:hover { color: #67b6ff; background: rgba(255,255,255,0.06); transform: translateY(-1px); }
        #rotation-toggle.locked { color: #e67e22; }
        
        #gyro-toggle {
            border: none;
            background: transparent;
            color: #f2f2f2;
            font-size: 18px;
            padding: 0 10px;
            min-width: 44px;
            height: 44px;
            border-radius: 8px;
            transition: color 0.12s ease, background 0.12s ease, transform 0.12s ease;
            cursor: pointer;
            display: none; /* Nascosto di default - appare solo su mobile */
        }
        #gyro-toggle:hover { color: #3498db; background: rgba(52,152,219,0.1); transform: translateY(-1px); }
        #gyro-toggle.active { color: #3498db; background: rgba(52,152,219,0.25); }

        /* --- Gestione Visibilità Intelligente per Device --- */
        /* Giroscopio: visibile SOLO su mobile/touch */
        body.touch #gyro-toggle,
        body.mobile #gyro-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Full Screen: visibile SOLO su desktop */
        #fullscreen-toggle {
            display: inline-flex;
        }
        body.touch #fullscreen-toggle,
        body.mobile #fullscreen-toggle {
            display: none !important;
        }

        /* Tasti più grandi su mobile per facilità di tocco */
        body.mobile .control-btn {
            min-width: 48px;
            height: 48px;
            font-size: 20px;
        }

        /* --- GALLERY CONTROLS --- */
        #controls-wrapper {
            display: none;
        }
        #controls { display: flex; gap: 10px; padding: 15px; justify-content: center; overflow-x: auto; }
        .scene-btn {
            width: 80px; border-radius: 6px; border: 2px solid transparent;
            cursor: pointer; background: #222; overflow: hidden; flex-shrink: 0;
        }
        .scene-btn.active { border-color: var(--accent); }
        .scene-btn img { width: 100%; height: 40px; object-fit: cover; display: block; }
        .btn-label { font-size: 9px; color: white; padding: 3px; text-align: center; }

        /* NAVIGAZIONE */
        .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: var(--bg-glass); color: white; cursor: pointer; z-index: 1000;
        }
        .nav-arrow.left { left: 15px; }
        .nav-arrow.right { right: 15px; }

        /* Cursore a mano su tutti gli elementi cliccabili del progetto */
        button, .map-btn, .hover-toggle, .scene-btn, .nav-arrow, .hotspot-info, .layer-item, #layer-toggle, #map-hover-toggle, #gallery-hover-toggle, .control-btn, #bar-toggle {
            cursor: pointer;
        }
        /* Leaflet interactive shapes (marker, polylines, etc.) devono mostrare il puntatore */
        .leaflet-interactive { cursor: pointer !important; }

        /* ============================================ */
        /* RESPONSIVE DESIGN - MOBILE & TABLET         */
        /* ============================================ */

        /* TABLET (max 1024px) */
        @media (max-width: 1024px) {
            #title-wrapper {
                top: 10px;
                left: 10px;
                gap: 8px;
            }
            
            #title {
                padding: 8px 14px;
                font-size: 13px;
            }
            
            #lang-toggle {
                padding: 6px 10px;
                font-size: 11px;
            }
            
            #map-box {
                top: 10px;
                right: 10px;
                width: 240px;
                height: 200px;
            }
            
            :root { 
                --bar-height: 120px;
                --thumb-size: 70px; 
                --thumb-gap: 6px; 
            }

            .control-btn {
                height: 40px;
                min-width: 40px;
                font-size: 16px;
            }
            
            #scene-caption {
                font-size: 12px;
            }
        }

        /* ================================================= */
        /* MOBILE & TABLET (Tasti Grandi per Dita)           */
        /* ================================================= */
        @media (max-width: 768px) {
            /* --- BARRA DI CONTROLLO PIÙ ALTA --- */
            :root { 
                --bar-height: 130px; /* Più spazio per i tasti grandi */
                --thumb-size: 70px;  
                --thumb-gap: 8px; 
            }

            /* --- TASTI DELLA BARRA (Rotazione, Gyro, Frecce) --- */
            .control-btn, #rotation-toggle, #gyro-toggle {
                height: 50px !important;    /* Altezza comoda */
                min-width: 50px !important; /* Larghezza comoda */
                font-size: 24px !important; /* Icona grande */
                padding: 0 !important;
                margin: 0 2px;
                background: rgba(255,255,255,0.1); /* Leggero sfondo per vederli meglio */
                border: 1px solid rgba(255,255,255,0.2);
            }
            
            /* --- BOTTONE APRI/CHIUDI BARRA --- */
            #bar-toggle { 
                width: 50px !important; 
                height: 50px !important; 
                font-size: 20px !important; 
                right: 15px; 
                bottom: calc(var(--bar-height) + 55px) !important; 
                background: rgba(0,0,0,0.8) !important;
                border: 1px solid rgba(255,255,255,0.3) !important;
            }

            /* --- MAPPA --- */
            /* ALZIAMO LA MAPPA IN ALTO A DESTRA */
            #map-box {
                top: 20px !important;   /* Allineata con il pulsante Info a sinistra */
                right: 20px !important; /* Margine standard */
                bottom: auto !important;
                width: 140px;
                height: 140px;
            }
            
            /* Quando è chiusa, il pallino sta in alto a destra, non in mezzo alla foto */
            #map-box.collapsed {
                top: 20px !important;
            }
            /* Tasto espandi mappa */
            #map-hover-toggle {
                width: 44px;
                height: 44px;
                font-size: 20px;
            }
            /* Tasti zoom mappa (se visibili) */
            .map-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            #layer-toggle {
                width: 44px;
                height: 40px;
            }
            
            /* --- INFO HOTSPOT --- */
            .hotspot-info {
                width: 44px;       /* Hotspot molto più cliccabile */
                height: 44px;
                margin-top: -22px; /* Ricalibra centro */
                margin-left: -22px;
                font-size: 22px;
            }

            /* --- BOTTONE INFO E LINGUA (in alto a sx) --- */
            #info-toggle {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            #info-widget {
                height: 50px;
            }
            #lang-toggle {
                font-size: 13px;
                padding: 8px 12px; /* Più facile da premere */
            }
            
            #scene-caption {
                font-size: 11px;
                padding: 0 12px;
            }
        }

        /* MOBILE STRETTO (max 600px) */
        @media (max-width: 600px) {
            #control-bar { width: min(98vw, calc(var(--thumb-count) * (var(--thumb-size) + var(--thumb-gap)) + 220px)); }
            :root { 
                --bar-height: 112px;
                --thumb-size: 58px; 
                --thumb-gap: 6px; 
            }
            #bar-toggle { width: 44px; height: 44px; font-size: 14px; right: 20px; bottom: calc(var(--bar-height) + 45px) !important; }
            #scene-caption { font-size: 10px; padding: 0 10px; }
            .control-btn { font-size: 12px; padding: 0 8px; }
        }

        /* MOBILE PORTRAIT (max 480px) */
        @media (max-width: 480px) {
            #title-wrapper {
                position: fixed;
                bottom: calc(var(--bar-height) + 120px);
                left: 50%;
                transform: translateX(-50%);
                top: auto;
                right: auto;
                flex-direction: row;
                justify-content: center;
                align-items: center;
                gap: 8px;
                max-width: 90vw;
                z-index: 1001;
            }
            
            #title {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 0;
                white-space: normal;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
                text-align: center;
            }
            
            #lang-toggle {
                padding: 5px 8px;
                font-size: 9px;
                flex-shrink: 0;
            }
            
            /* Mappa: ottimizzata per mobile - più piccola e meno invasiva */
            #map-box {
                top: 150px;
                right: 10px;
                width: 140px;
                height: 140px;
                border-radius: 12px;
                border: 2px solid rgba(255,255,255,0.3);
            }
            
            /* Nascondi i controlli zoom della mappa su mobile per risparmiare spazio */
            .map-controls {
                display: none !important;
            }
            
            #map-box.collapsed {
                width: 44px;
                height: 44px;
            }
            
            #map-box.collapsed #map-coordinates {
                display: none;
            }
            
            #map-box.collapsed #map-hover-toggle {
                width: 38px;
                height: 38px;
            }
            
            .map-header {
                height: 28px;
                padding: 4px 6px;
            }
            
            .map-title {
                font-size: 11px;
            }
            
            .map-layer-name {
                font-size: 10px;
            }
            
            .map-controls {
                top: 32px;
                left: 6px;
                gap: 6px;
            }
            
            .map-controls-right {
                top: 32px;
                right: 6px;
                gap: 6px;
            }
            
            .map-btn {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            #layer-toggle {
                width: 32px;
                height: 28px;
            }
            
            #layer-toggle svg {
                width: 14px;
                height: 14px;
            }
            
            .map-attribution {
                font-size: 9px;
                padding: 2px 4px;
            }
            
            .hover-toggle {
                width: 28px;
                height: 28px;
            }
            
            /* Hotspot più piccoli su mobile */
            .hotspot-info {
                width: 28px;
                height: 28px;
                margin-top: -14px;
                margin-left: -14px;
                font-size: 14px;
            }
            
            /* Barra di controllo ottimizzata per mobile */
            :root { 
                --bar-height: 100px;
                --thumb-size: 56px; 
                --thumb-gap: 6px; 
            }
            #bar-toggle { width: 44px; height: 44px; font-size: 11px; right: 20px; bottom: calc(var(--bar-height) + 45px) !important; }
            
            #control-bar-top {
                height: 36px;
                padding: 0 8px;
                gap: 6px;
            }
            
            #control-bar-bottom {
                height: 64px;
                padding: 6px 8px;
                gap: 4px;
            }
            
            .control-btn {
                height: 32px;
                min-width: 32px;
                font-size: 14px;
                padding: 0 6px;
                gap: 4px;
            }
            
            .control-btn svg {
                width: 14px;
                height: 14px;
            }
            
            #rotation-toggle {
                min-width: 32px;
                height: 32px;
                font-size: 14px;
                padding: 0 6px;
            }
            
            #scene-caption {
                font-size: 10px;
                padding: 0 8px;
                line-height: 1.3;
            }
            
            /* Nascondi le frecce di navigazione su mobile - poco utili con touch */
            .nav-arrow {
                width: 38px;
                height: 38px;
            }
            
            .nav-arrow.left {
                left: 8px;
            }
            
            .nav-arrow.right {
                right: 8px;
            }
        }

        /* MOBILE EXTRA SMALL (max 360px) */
        @media (max-width: 360px) {
            #title {
                font-size: 10px;
                padding: 5px 8px;
            }
            
            #lang-toggle {
                font-size: 8px;
                padding: 4px 6px;
            }
            
            #map-box {
                width: 130px;
                height: 100px;
            }
            
            :root { 
                --bar-height: 90px;
                --thumb-size: 48px; 
                --thumb-gap: 4px; 
            }
            #bar-toggle {
                width: 44px;
                height: 44px;
                font-size: 10px;
                right: 20px;
                bottom: calc(var(--bar-height) + 45px) !important;
            }
            
            #control-bar-bottom {
                height: 54px;
                padding: 4px 6px;
            }
            
            #scene-caption {
                font-size: 9px;
                padding: 0 6px;
            }
            
            .control-btn {
                height: 28px;
                min-width: 28px;
                font-size: 12px;
                padding: 0 4px;
            }
        }

        /* ORIENTAMENTO LANDSCAPE SU MOBILE (altezza ridotta) */
        @media (max-height: 500px) and (orientation: landscape) {
            #title-wrapper {
                top: 5px;
                left: 5px;
            }
            
            #title {
                padding: 4px 8px;
                font-size: 10px;
            }
            
            #lang-toggle {
                padding: 3px 6px;
                font-size: 9px;
            }
            
            #map-box {
                top: 5px;
                right: 5px;
                width: 140px;
                height: 100px;
            }
            
            #control-bar {
                --bar-height: 70px;
            }
            
            #bar-toggle {
                width: 44px;
                height: 44px;
                font-size: 9px;
                right: 20px;
                bottom: calc(var(--bar-height) + 45px) !important;
            }
            
            #control-bar-top {
                height: 28px;
            }
            
            #control-bar-bottom {
                height: 42px;
                padding: 4px 6px;
            }
            
            :root { --thumb-size: 40px; --thumb-gap: 6px; }
            
            .control-btn {
                height: 26px;
                min-width: 26px;
                font-size: 12px;
            }
            
            #scene-caption {
                font-size: 9px;
            }
            
            /* Nascondi frecce navigazione in landscape - spazio limitato */
            .nav-arrow {
                display: none;
            }
        }
    </style>
</head>
<body>

<div id="pano"></div>

<div id="top-left-controls">
    
    <div id="info-widget">
        <button id="info-toggle" onclick="toggleInfoTitle()" aria-label="Info e Titolo">i</button>
        <div id="info-label">
            <span id="info-text-content">ADIGE RIVER VIRTUAL TOUR</span>
        </div>
    </div>

    <button id="lang-toggle" onclick="toggleLanguage()" title="Cambia lingua / Change language">
        <span class="lang-it active">IT</span> | <span class="lang-en">EN</span>
    </button>
</div>

<div id="map-box">
    <div class="map-header">
        <div style="display:flex;align-items:center;gap:6px">
            <div class="map-title" id="map-title-text">Mappa</div>
            <div class="map-layer-name" id="map-layer-name" style="font-size: 10px; opacity: 0.8;">OSM</div>
            <div id="map-coordinates" style="font-size: 10px; color: #bbb; margin-left: 10px; font-family: inherit;"></div>
        </div>
        <!-- header controls left intentionally minimal; layer button moved into map controls -->
    </div>
    <div id="mapContainer"></div>
    <div class="map-attribution" id="map-attribution"></div>
    <div class="map-controls">
        <button class="map-btn" onclick="zoomIn()" id="zoom-in-btn" title="Zoom In">+</button>
        <button class="map-btn" onclick="zoomOut()" id="zoom-out-btn" title="Zoom Out">−</button>
    </div>
    <!-- Pulsanti a destra (es. cambio layer) - stessa tipologia dei map-btn ma posizionati a destra -->
    <div class="map-controls-right">
        <button class="map-btn" id="layer-toggle" onclick="toggleLayer()" title="Cambia strato" aria-label="Cambia strato">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M12 3L2 8l10 5 10-5-10-5z" fill="currentColor"/>
                <path d="M12 10l-10 5 10 5 10-5-10-5z" fill="currentColor" opacity="0.9"/>
                <path d="M12 17l-10 5 10 5 10-5-10-5z" fill="currentColor" opacity="0.7" transform="translate(0,-8) scale(0.9)"/>
            </svg>
        </button>
        <button class="map-btn" id="center-map-btn" onclick="centerMapOnMarkers()" title="Centra mappa" aria-label="Centra mappa">⌖</button>
    </div>
    <button id="map-hover-toggle" class="hover-toggle" onclick="toggleMap()" title="Espandi/Comprimi mappa" aria-label="Espandi/Comprimi mappa">⇳</button>
</div>

<div id="controls-wrapper">
    <button id="controls-toggle" onclick="toggleControls()" title="Espandi/Contrai galleria viste" aria-label="Espandi o comprimi la galleria viste">
        <span style="display:inline-flex;align-items:center;gap:8px">GALLERIA VISTE
            <!-- Freccia verso il basso per indicare espandi/contrai -->
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M7 10l5 5 5-5H7z" fill="currentColor" />
            </svg>
        </span>
    </button>
    <button id="gallery-hover-toggle" class="hover-toggle" onclick="toggleControls()" title="Espandi/Contrai galleria viste" aria-label="Espandi o comprimi la galleria viste">⇳</button>
    <div id="controls"></div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="./marzipano.js"></script>
<script src="./data.js"></script>
<script src="./data-translations.js"></script>

<script>
// === SISTEMA MULTI-LINGUA ===
var translations = {
  it: {
    title: "TOUR VIRTUALE LUNGO IL FIUME ADIGE",
    rotationToggle: "Blocca/Sblocca rotazione",
    fullscreen: "Schermo intero",
    prevView: "Vista precedente",
    nextView: "Vista successiva",
    showBar: "Mostra barra",
    hideBar: "Nascondi barra",
    expandGallery: "Espandi/Contrai galleria viste",
    layerOSM: "OSM",
    layerSatellite: "Satellite",
    layerCartoDB: "CartoDB",
    mapTitle: "Mappa",
    mapExpandCollapse: "Espandi/Comprimi mappa",
    zoomIn: "Zoom In",
    zoomOut: "Zoom Out",
    changeLayer: "Cambia strato",
    centerMap: "Centra mappa",
    closeModal: "Chiudi",
    loading: "Caricamento tour in corso...",
    gyroMode: "Modalità Visore (Giroscopio)"
  },
  en: {
    title: "VIRTUAL TOUR ALONG THE ADIGE RIVER",
    rotationToggle: "Lock/Unlock rotation",
    fullscreen: "Fullscreen",
    prevView: "Previous view",
    nextView: "Next view",
    showBar: "Show bar",
    hideBar: "Hide bar",
    expandGallery: "Expand/Collapse gallery views",
    layerOSM: "OSM",
    layerSatellite: "Satellite",
    layerCartoDB: "CartoDB",
    mapTitle: "Map",
    mapExpandCollapse: "Expand/Collapse map",
    zoomIn: "Zoom In",
    zoomOut: "Zoom Out",
    changeLayer: "Change layer",
    centerMap: "Center map",
    closeModal: "Close",
    loading: "Loading tour...",
    gyroMode: "VR Mode (Gyroscope)"
  }
};
var currentLanguage = localStorage.getItem('tourLanguage') || 'it';

var sceneCaptions = {
    it: {
        panorama1: "Sponde F. Adige invase da liane aliene",
        panorama2: "Dettaglio invasione liane aliene (Sicyos angulatus)",
        panorama3: "Foce del F. Adige"
    },
    en: {
        panorama1: "River Adige banks invaded by alien vines",
        panorama2: "Detail of alien vine invasion (Sicyos angulatus)",
        panorama3: "Adige river mouth"
    }
};

function getSceneCaption(sceneId) {
    if (!sceneId) return '';
    var langMap = sceneCaptions[currentLanguage] || sceneCaptions.it || {};
    return langMap[sceneId] || (sceneCaptions.it ? sceneCaptions.it[sceneId] : '') || '';
}

function refreshSceneCaption(index) {
    var captionEl = document.getElementById('scene-caption');
    if (!captionEl) return;
    var sceneData = scenes && scenes[index];
    var sceneId = sceneData && (sceneData.id || (sceneData.data && sceneData.data.id));
    // Fallback: se per qualche motivo non abbiamo l'id, usa quello definito in data.js
    if (!sceneId && window.data && window.data.scenes && window.data.scenes[index]) {
        sceneId = window.data.scenes[index].id;
    }
    captionEl.innerText = getSceneCaption(sceneId);
}

function getTranslation(key) {
  return (translations[currentLanguage] && translations[currentLanguage][key]) || translations['it'][key] || key;
}

// --- LOGICA TITOLO A COMPARSA ---
var infoTimer = null;

function toggleInfoTitle() {
    var widget = document.getElementById('info-widget');
    if (!widget) return;
    
    // Se è già aperto, lo chiudiamo. Se è chiuso, lo apriamo con timer.
    if (widget.classList.contains('active')) {
        closeInfoTitle();
    } else {
        openInfoTitle(true); // true = usa timer per auto-chiusura
    }
}

function openInfoTitle(autoClose) {
    var widget = document.getElementById('info-widget');
    if (!widget) return;

    // Resetta timer precedenti
    if (infoTimer) clearTimeout(infoTimer);

    widget.classList.add('active');

    // Se richiesto, chiudi dopo 4 secondi per lettura più calma
    if (autoClose) {
        infoTimer = setTimeout(function() {
            closeInfoTitle();
        }, 4000); // 4000ms = 4 secondi
    }
}

function closeInfoTitle() {
    var widget = document.getElementById('info-widget');
    if (widget) widget.classList.remove('active');
}

function setLanguage(lang) {
  if (!translations[lang]) return;
  currentLanguage = lang;
  localStorage.setItem('tourLanguage', lang);
  console.log('🌐 Lingua cambiata a:', lang);
  
  // Aggiorna titolo nel nuovo widget info
  var titleTextEl = document.getElementById('info-text-content');
  if (titleTextEl) {
    titleTextEl.innerText = (lang === 'it') ? 'Tour Lungo il Fiume Adige' : 'Adige River Virtual Tour';
  }
  
  // Aggiorna bottoni
  var rotBtn = document.getElementById('rotation-toggle');
  if (rotBtn) {
    rotBtn.title = getTranslation('rotationToggle');
    rotBtn.setAttribute('aria-label', getTranslation('rotationToggle'));
  }
  
  var gyroBtn = document.getElementById('gyro-toggle');
  if (gyroBtn) {
    gyroBtn.title = getTranslation('gyroMode');
    gyroBtn.setAttribute('aria-label', getTranslation('gyroMode'));
  }
  
  var fullscreenBtn = document.getElementById('fullscreen-toggle');
  if (fullscreenBtn) {
    fullscreenBtn.title = getTranslation('fullscreen');
    fullscreenBtn.setAttribute('aria-label', getTranslation('fullscreen'));
  }
  
  // Aggiorna frecce navigate
  var buttons = document.querySelectorAll('button[onclick*="navigateScene"]');
  buttons.forEach(function(btn) {
    if (btn.onclick.toString().includes('navigateScene(-1)')) {
      btn.title = getTranslation('prevView');
      btn.setAttribute('aria-label', getTranslation('prevView'));
    } else if (btn.onclick.toString().includes('navigateScene(1)')) {
      btn.title = getTranslation('nextView');
      btn.setAttribute('aria-label', getTranslation('nextView'));
    }
  });
  
  // Aggiorna bottone barra
  var barToggle = document.getElementById('bar-toggle');
  if (barToggle) {
    barToggle.title = barToggle.classList.contains('collapsed') ? getTranslation('showBar') : getTranslation('hideBar');
  }
  
  // Aggiorna titolo mappa
  var mapTitleEl = document.getElementById('map-title-text');
  if (mapTitleEl) {
    mapTitleEl.innerText = getTranslation('mapTitle');
  }
  
    // Aggiorna bottone expand/collapse mappa
    var mapToggleBtn = document.getElementById('map-hover-toggle');
    if (mapToggleBtn) {
        mapToggleBtn.title = getTranslation('mapExpandCollapse');
        mapToggleBtn.setAttribute('aria-label', getTranslation('mapExpandCollapse'));
    }
  
    // Aggiorna bottoni zoom della mappa
    var zoomInBtn = document.getElementById('zoom-in-btn');
    if (zoomInBtn) {
        zoomInBtn.title = getTranslation('zoomIn');
    }
  
    var zoomOutBtn = document.getElementById('zoom-out-btn');
    if (zoomOutBtn) {
        zoomOutBtn.title = getTranslation('zoomOut');
    }
  
    // Aggiorna bottone change layer
    var layerToggleBtn = document.getElementById('layer-toggle');
    if (layerToggleBtn) {
        layerToggleBtn.title = getTranslation('changeLayer');
    }
    
    // Aggiorna bottone centra mappa
    var centerMapBtn = document.getElementById('center-map-btn');
    if (centerMapBtn) {
        centerMapBtn.title = getTranslation('centerMap');
        centerMapBtn.setAttribute('aria-label', getTranslation('centerMap'));
    }
  
  // Effetto visivo sul bottone lingua: grassetto sulla lingua attiva
  var langBtn = document.getElementById('lang-toggle');
  if (langBtn) {
    var langItSpan = langBtn.querySelector('.lang-it');
    var langEnSpan = langBtn.querySelector('.lang-en');
    if (lang === 'it') {
      if (langItSpan) langItSpan.classList.add('active');
      if (langEnSpan) langEnSpan.classList.remove('active');
    } else if (lang === 'en') {
      if (langItSpan) langItSpan.classList.remove('active');
      if (langEnSpan) langEnSpan.classList.add('active');
    }
  }
    refreshSceneCaption(currentSceneIndex);
  
  console.log('✓ Aggiornamenti linguistici completati');
}

function toggleLanguage() {
  var newLang = currentLanguage === 'it' ? 'en' : 'it';
  setLanguage(newLang);
}

function updateLayerNames() {
  if (layers && layers.length >= 3) {
    layers[0].name = getTranslation('layerOSM');
    layers[1].name = getTranslation('layerSatellite');
    layers[2].name = getTranslation('layerCartoDB');
    var nameEl = document.getElementById('map-layer-name');
    if (nameEl) nameEl.innerText = layers[currentLayerIndex].name;
    buildLayerMenu();
  }
}

// TILES per rendering veloce (con ottimizzazioni anti-pezzi-mancanti)
const panoramaFiles = ['panorama1.tiles', 'panorama2.tiles', 'panorama3.tiles'];
// JPG originali per lettura GPS EXIF
const panoramaFilesForGps = ['panorama1.jpg', 'panorama2.jpg', 'panorama3.jpg'];
// Determina il percorso base dinamicamente
const baseURL = window.location.pathname.includes('/tour_adige/') 
    ? '/tour_adige/' 
    : './';
const folder = baseURL + 'panorami/';

// Crea viewer
var viewer = new Marzipano.Viewer(document.getElementById('pano'));

// Abilita esplicitamente i controlli di zoom
var controls = viewer.controls();
controls.registerMethod('scroll', new Marzipano.ScrollZoomControlMethod(document.getElementById('pano')));
controls.registerMethod('pinch', new Marzipano.PinchZoomControlMethod(document.getElementById('pano'), 'touch'));

var scenes = [];
var markers = [];
var map, currentView, currentSceneIndex = 0;
var autorotate = Marzipano.autorotate({ yawSpeed: 0.02, targetPitch: 0 });
var preloadingComplete = false;
var baseLayer, satelliteLayer, cartoLayer, layers = [], currentLayerIndex = 0;
var rotationLocked = false;
var rotationTimer = null; // timer per riabilitare la rotazione dopo X ms
var rotationLockMode = null; // null | 'manual' | 'temporary'
var gyroEnabled = false; // Stato della modalità giroscopio
var isDeviceMobile = false; // Rilevamento device

// === RILEVAMENTO DEVICE TYPE ===
function detectDeviceType() {
    var ua = navigator.userAgent;
    var isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
    var isTablet = /iPad|Android(?!.*Mobile)/i.test(ua);
    var hasTouch = () => {
        try { return (('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0)); }
        catch(e) { return false; }
    };
    
    isDeviceMobile = isMobile || hasTouch();
    
    // Aggiungi classe al body per gestire CSS intelligente
    var classList = document.body.classList;
    if (hasTouch()) classList.add('touch');
    if (isMobile || isTablet) classList.add('mobile');
    
    console.log('📱 Device Type Detected:', { isMobile, isTablet, hasTouch: hasTouch(), isDeviceMobile });
}

// Richiama il rilevamento non appena il DOM è carico
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', detectDeviceType);
} else {
    detectDeviceType();
}

// AUTO-HIDE DISATTIVATO: La UI rimane sempre visibile
function showUI() {
    // Auto-hide disabilitato - la barra rimane sempre aperta di default
    // Non fare nulla
}

function hideUI() {
    // Auto-hide disabilitato - la barra rimane sempre aperta di default
    // Non fare nulla
}

function toggleGyro() {
    var btn = document.getElementById('gyro-toggle');
    if (!btn) return;
    
    // Verifica se il dispositivo supporta giroscopio
    if (typeof DeviceOrientationEvent === 'undefined') {
        console.warn('⚠️ Giroscopio non disponibile su questo dispositivo');
        alert('Questo dispositivo non supporta il giroscopio.');
        return;
    }
    
    // Gestione permessi iOS 13+
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        // iOS 13+: richiedi permesso esplicito
        DeviceOrientationEvent.requestPermission()
            .then(permissionState => {
                if (permissionState === 'granted') {
                    activateGyroLogic(btn);
                } else {
                    console.warn('⚠️ Permesso giroscopio negato dall\'utente');
                    alert('Permesso giroscopio negato. Abilita in Impostazioni > Privacy > Movimento e orientamento.');
                }
            })
            .catch(err => {
                console.warn('❌ Errore richiesta permesso giroscopio:', err);
            });
    } else {
        // Android e altri browser: attiva direttamente
        activateGyroLogic(btn);
    }
}

function activateGyroLogic(btn) {
    gyroEnabled = !gyroEnabled;
    
    // Icona VR OFF (Occhiali normali)
    var svgGyroOff = '<svg viewBox="0 0 24 24"><path d="M6 9l2.5-4h7l2.5 4H6zM2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6H2zm4 3a2 2 0 100 4 2 2 0 000-4zm12 0a2 2 0 100 4 2 2 0 000-4z" /></svg>';
    // Icona VR ON (Piena)
    var svgGyroOn = '<svg viewBox="0 0 24 24"><path d="M2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6H2zm4 3a2 2 0 100 4 2 2 0 000-4zm12 0a2 2 0 100 4 2 2 0 000-4z" fill="currentColor" stroke="none"/></svg>';
    
    if (gyroEnabled) {
        console.log('📱 Modalità Giroscopio attivata');
        
        // Disabilita rotazione automatica
        stopAutoRotation();
        
        // Tenta di disabilitare controlli classici per evitare conflitti
        try {
            if (viewer && viewer.controls && typeof viewer.controls === 'function') {
                var controls = viewer.controls();
                if (controls) {
                    // Prova a disabilitare i metodi di controllo standard
                    if (typeof controls.disableMethod === 'function') {
                        controls.disableMethod('mouseViewDrag');
                        controls.disableMethod('touchView');
                    }
                }
            }
        } catch(e) { console.log('Disabilitazione controlli classici (non critico):', e); }
        
        // Attiva listener per orientamento dispositivo
        window.addEventListener('deviceorientation', handleDeviceOrientation, { passive: true });
        
        // Feedback visivo: cambio colore e icona
        btn.innerHTML = svgGyroOn;
        btn.classList.add('active');
        btn.title = getTranslation('gyroMode') + ' (ATTIVO)';
        var svg = btn.querySelector('svg');
        if (svg) svg.style.stroke = '#3498db';
        
        // Opzionale: nascondi UI per immersione VR
        // var controlBar = document.getElementById('control-bar');
        // if (controlBar) controlBar.classList.add('collapsed');
        
    } else {
        console.log('📱 Modalità Giroscopio disattivata');
        window.removeEventListener('deviceorientation', handleDeviceOrientation);
        
        // Ri-abilita controlli classici
        try {
            if (viewer && viewer.controls && typeof viewer.controls === 'function') {
                var controls = viewer.controls();
                if (controls && typeof controls.enableMethod === 'function') {
                    controls.enableMethod('mouseViewDrag');
                    controls.enableMethod('touchView');
                }
            }
        } catch(e) { console.log('Riabilitazione controlli classici (non critico):', e); }
        
        // Feedback visivo: ritorna a normale
        btn.innerHTML = svgGyroOff;
        btn.classList.remove('active');
        btn.title = getTranslation('gyroMode');
        var svg = btn.querySelector('svg');
        if (svg) svg.style.stroke = '';
    }
}

function handleDeviceOrientation(event) {
    if (!gyroEnabled || !viewer || !currentView) return;
    
    try {
        var alpha = (event.alpha || 0) * Math.PI / 180; // Z: rotazione sinistra-destra (compass)
        var beta = (event.beta || 0) * Math.PI / 180;   // X: avanti-indietro (tilt)
        var gamma = (event.gamma || 0) * Math.PI / 180; // Y: rotazione left-right (roll)
        
        // Usa alpha (compass) come yaw principale
        // Usa beta (tilt) come pitch
        var yaw = -alpha;
        var pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, -beta));
        
        // Aggiorna la vista del panorama in tempo reale
        if (typeof currentView.setParameters === 'function') {
            currentView.setParameters({ yaw: yaw, pitch: pitch }, { transitionDuration: 0 });
        }
    } catch(e) { 
        console.warn('Errore in handleDeviceOrientation (non critico):', e);
    }
}

function convertToDecimal(ref, deg, min, sec) {
    var factor = (ref === 'S' || ref === 'W') ? -1 : 1;
    return factor * (deg + (min / 60) + (sec / 3600));
}

function getGpsData(url) {
    return new Promise((resolve) => {
        var img = new Image();
        img.onload = function() {
            try {
                EXIF.getData(img, function() {
                    try {
                        var lat = EXIF.getTag(this, "GPSLatitude");
                        var lng = EXIF.getTag(this, "GPSLongitude");
                        if (lat && lng) {
                            resolve({
                                lat: convertToDecimal(EXIF.getTag(this, "GPSLatitudeRef"), lat[0], lat[1], lat[2]),
                                lng: convertToDecimal(EXIF.getTag(this, "GPSLongitudeRef"), lng[0], lng[1], lng[2])
                            });
                        } else resolve(null);
                    } catch (e) {
                        console.warn('EXIF parsing error for ' + url, e);
                        resolve(null);
                    }
                });
            } catch (e) {
                console.warn('EXIF getData error for ' + url, e);
                resolve(null);
            }
        };
        img.onerror = function() { 
            console.warn('Failed to load GPS image: ' + url);
            resolve(null); 
        };
        img.src = url;
    });
}

async function init() {
    // Mostra loader
    showLoader(getTranslation('loading'));
    
    let locations = [];
    let locationsFallback = false;
    
    console.log('=== CARICAMENTO COORDINATE ===');
    
    // PRIORITÀ 1: Leggi coordinate da data.js (HARDCODED - più veloce)
    if (window.data && window.data.coordinates && window.data.coordinates.length > 0) {
        console.log('✓ Coordinate caricate da data.js: ' + window.data.coordinates.length + ' trovate');
        locations = window.data.coordinates.map((coord, idx) => ({
            lat: coord.lat,
            lng: coord.lng,
            file: panoramaFiles[idx]
        }));
    } 
    // PRIORITÀ 2: Se no coordinates in data.js, leggi dal GPS EXIF delle immagini
    else {
        console.log('Tentativo lettura GPS da EXIF (fallback)...');
        try {
            var gpsPromises = panoramaFilesForGps.map((file, idx) => 
                getGpsData(folder + file)
                    .then(coords => ({ coords, file: panoramaFiles[idx] }))
                    .catch(err => { console.warn('Errore GPS per ' + file, err); return { coords: null, file: null }; })
            );
            var gpsResults = await Promise.all(gpsPromises);
            locations = gpsResults
                .filter(r => r.coords && r.file)
                .map(r => ({ ...r.coords, file: r.file }));
            if (locations.length > 0) {
                console.log('✓ GPS letto da immagini (EXIF): ' + locations.length + ' coordinate trovate');
            }
        } catch (e) {
            console.warn('Errore lettura GPS in parallelo:', e);
        }
        
        // PRIORITÀ 3: Se ancora nessuna coordinata, usa fallback simbolico
        if (!locations.length) {
            locationsFallback = true;
            locations = panoramaFiles.map((file, idx) => ({
                lat: 0.0001 * idx,
                lng: 0.0001 * idx,
                file
            }));
            console.warn('Nessun GPS trovato: uso fallback simbolico');
        }
    }

    // Inizializza mappa ma non caricare i tiles subito (lazy load)
    map = L.map('mapContainer', { 
        zoomControl: false, 
        attributionControl: false, 
        preferCanvas: true,
        touchZoom: true,      // Abilita pinch-to-zoom
        touch: true,          // Abilita touch drag
        dragging: true,       // Abilita trascinamento
        doubleClickZoom: true,
        scrollWheelZoom: false,
        tap: true,            // Tap per doppio click su mobile
        tapTolerance: 15,     // Tolleranza tap in px
        bounceAtZoomLimits: true
    });
    
    // Layer base (OpenStreetMap) - default più familiare e professionale
    baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 18,
        updateWhenIdle: true  // Carica tiles solo quando la mappa è ferma
    });
    
    // Layer satellitare
    satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri',
        maxZoom: 18,
        updateWhenIdle: true
    });

    // Layer Carto (light)
    cartoLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CartoDB',
        maxZoom: 18,
        updateWhenIdle: true
    });

    // layers array: ogni elemento ha {layer, name, icon}
    layers = [
        { layer: baseLayer, name: getTranslation('layerOSM'), icon: '🗺️', attribution: '© OpenStreetMap contributors' },
        { layer: satelliteLayer, name: getTranslation('layerSatellite'), icon: '🛰️', attribution: 'Esri' },
        { layer: cartoLayer, name: getTranslation('layerCartoDB'), icon: '🗺️', attribution: 'CartoDB' }
    ];

    // usa la funzione setLayer per aggiungere il layer di default
    setLayer(0);
    // costruisci il menu dei layer
    buildLayerMenu();
    
    // Impedisce che i tocchi sulla mappa muovano il panorama 360 - blocco SELETTIVO
    var mapEl = document.getElementById('map-box');
    var mapContainer = document.getElementById('mapContainer');
    
    // Blocca solo sul container interno della mappa (non su tutto map-box)
    mapContainer.addEventListener('touchstart', function(e) { 
        e.stopPropagation(); 
    }, {passive: true}); // passive: true per Leaflet possa preventDefault
    
    mapContainer.addEventListener('touchmove', function(e) { 
        // NON bloccare - lascia che Leaflet lo gestisca
    }, {passive: false});
    
    mapContainer.addEventListener('touchend', function(e) { 
        e.stopPropagation(); 
    }, {passive: true});

    locations.forEach((data, index) => {
        // 4 livelli corrispondenti alle cartelle 1,2,3,4 (z Marzipano 0,1,2,3)
        var levelsOptimized = [
            { tileSize: 512, size: 512, fallbackOnly: true },
            { tileSize: 512, size: 1024 },
            { tileSize: 512, size: 2048 },
            { tileSize: 512, size: 4096 }
        ];
        
        var isTiled = data.file.includes('.tiles');
        var source, geometry;
        
        if (isTiled) {
            var urlPrefix = folder + data.file;
            // Mapping corretto per la struttura delle cartelle Marzipano
            source = new Marzipano.ImageUrlSource(function(tile) {
                var level = tile.z + 1; // Le tue cartelle partono da 1, Marzipano da 0
                var face = tile.face;
                var x = tile.x;
                var y = tile.y;
                
                // Costruzione dinamica del percorso file
                var path = urlPrefix + '/' + face + '/' + level + '/';
                if (y !== 0) {
                    path += y + '/';
                }
                path += x + '.jpg';
                
                return { url: path };
            }, {
                cubeMapPreviewUrl: urlPrefix + "/preview.jpg",
                concurrency: 4, // Limite per stabilità su GitHub Pages
                retryDelay: 500 // Riprova dopo 500ms se una tile fallisce
            });
            geometry = new Marzipano.CubeGeometry(levelsOptimized);
        } else {
            // Fallback equirettangolare
            source = Marzipano.ImageUrlSource.fromString(folder + data.file);
            geometry = new Marzipano.EquirectGeometry([{ width: 1000 }, { width: 2000 }, { width: 4000 }, { width: 8000 }]);
        }
        
        // --- CALCOLO ZOOM INTELLIGENTE ---
        var isMobile = window.innerWidth < 768;
        var isPortrait = window.innerHeight > window.innerWidth;

        // Definiamo i gradi in base all'orientamento
        var minFovDeg, maxFovDeg, initialFovDeg;

        if (isMobile) {
            if (isPortrait) {
                // MOBILE VERTICALE (Il caso critico)
                minFovDeg = 20;   // Zoom IN massimo (molto stretto per vedere dettagli)
                maxFovDeg = 120;  // Permette di "allontanare" la vista col touch
                initialFovDeg = 85; // Parte con una vista più ampia
            } else {
                // MOBILE ORIZZONTALE
                minFovDeg = 25;
                maxFovDeg = 100;
                initialFovDeg = 75;
            }
        } else {
            // DESKTOP
            minFovDeg = 15;   // Zoom IN potente
            maxFovDeg = 120;  // Grandangolo
            initialFovDeg = 85;
        }

        // Conversione in radianti
        var fovMin = minFovDeg * Math.PI / 180;
        var fovMax = maxFovDeg * Math.PI / 180;
        var fovInitial = initialFovDeg * Math.PI / 180;

        // Applicazione Limiter
        var limiter = Marzipano.RectilinearView.limit.traditional(4096, fovMin, fovMax);

        var view = new Marzipano.RectilinearView({ 
            yaw: 0, 
            pitch: 0, 
            fov: fovInitial 
        }, limiter);
        
        // Cache aumentata a 500MB per evitare che texture spariscano
        var scene = viewer.createScene({ 
            source: source, 
            geometry: geometry, 
            view: view,
            pinFirstLevel: true,  // TIENE SEMPRE IL LIVELLO SFOCATO SOTTO (mai più nero!)
            textureStoreOpts: {
                previouslyVisibleCacheSize: 500 * 1024 * 1024  // 500MB di cache
            }
        });
        
        // Conserva l'id di scena per collegare le didascalie
        var sceneMeta = (window.data && window.data.scenes && window.data.scenes[index]) ? window.data.scenes[index] : null;
        var sceneId = sceneMeta ? sceneMeta.id : null;
        scenes.push({
            scene,
            view,
            lat: data.lat,
            lng: data.lng,
            id: sceneId,
            hotspotsCreated: false,
            isTiled
        });

        var marker = L.circleMarker([data.lat, data.lng], { radius: 7, fillColor: "#3498db", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map);
        marker.on('click', () => switchScene(index));
        markers.push(marker);

        var btn = document.createElement('button');
        btn.className = 'scene-btn';
        // Usa preview.jpg per tiles (più leggera), immagine originale per jpg
        var thumbSrc = isTiled ? folder + data.file + '/preview.jpg' : folder + data.file;
        btn.innerHTML = `<img src="${thumbSrc}" loading="lazy"><div class="btn-label">Punto ${index+1}</div>`;
        btn.onclick = () => switchScene(index);
        document.getElementById('controls').appendChild(btn);
        
        // Aggiungi thumbnail alla strip in basso
        var thumb = document.createElement('div');
        thumb.className = 'thumb-item';
        thumb.innerHTML = `<img src="${thumbSrc}" alt="Punto ${index+1}" loading="lazy">`;
        thumb.onclick = () => switchScene(index);
        var track = document.getElementById('thumb-track');
        if (track) track.appendChild(thumb);
    });

    // Aggiorna la variabile CSS per dimensionare la barra in base al numero di viste
    try {
        // Forza il conteggio esatto delle miniature per sicurezza
        var thumbCount = scenes.length || 3;
        document.documentElement.style.setProperty('--thumb-count', thumbCount);
    } catch(e) {}
    
    // Se abbiamo coordinate reali facciamo fitBounds, altrimenti centriamo su (0,0)
    if (!locationsFallback) {
        map.fitBounds(L.latLngBounds(locations.map(l => [l.lat, l.lng])), {padding: [30,30]});
    } else {
        try { map.setView([0, 0], 2); } catch(e) { /* non critico */ }
        // evidenzia nel titolo che la mappa è simbolica
        const layerName = document.getElementById('map-layer-name');
        if (layerName) layerName.innerText = 'OSM (no GPS)';
    }

    // --- LOGICA COORDINATE PER F12 ---
    // Cattura le coordinate yaw/pitch del punto cliccato (non del centro della view)
    document.getElementById('pano').addEventListener('mousedown', function(ev) {
        if (!currentView) return;
        try {
            var rect = this.getBoundingClientRect();
            var x = ev.clientX - rect.left;
            var y = ev.clientY - rect.top;
            // Usa l'API di Marzipano per convertire coordinate schermo -> yaw/pitch
            var coords = currentView.screenToCoordinates({ x: x, y: y });
            if (coords && typeof coords.yaw === 'number') {
                console.log('%c📍 NUOVO HOTSPOT:', 'color: #e74c3c; font-weight: bold;');
                console.log(`{ "yaw": ${coords.yaw.toFixed(4)}, "pitch": ${coords.pitch.toFixed(4)}, "title": "Titolo", "text": "Descrizione" },`);
                return;
            }
        } catch (err) {
            // fallback: se la conversione fallisce, logga la view corrente
            console.warn('screenToCoordinates failed, falling back to currentView center', err);
        }
        // Fallback: logga lo yaw/pitch corrente (centro view)
        try {
            var yaw = currentView.yaw();
            var pitch = currentView.pitch();
            console.log('%c📍 NUOVO HOTSPOT (fallback center):', 'color: #e74c3c; font-weight: bold;');
            console.log(`{ "yaw": ${yaw.toFixed(4)}, "pitch": ${pitch.toFixed(4)}, "title": "Titolo", "text": "Descrizione" },`);
        } catch(e) {}
    });

    // Carica solo la prima scena inizialmente per velocizzare
    switchScene(0);
    // Autorotazione attiva di default
    startAutoRotation();
    updateRotationButton();
    
    // Applica la lingua salvata o predefinita
    setLanguage(currentLanguage);
    
    // Nascondi loader rapidamente dopo che la prima scena è pronta
    setTimeout(() => hideLoader(), 300);
    
    // Ritarda il caricamento tiles della mappa per non competere con il panorama (aumentato per GitHub Pages)
    setTimeout(() => {
        if (map) {
            map.invalidateSize();
            console.log('✓ Mappa lazy-loaded');
        }
    }, 3000);
    
    // Precarica le altre scene solo dopo che la mappa è caricata
    setTimeout(() => preloadScenes(), 2500);
    
    // Gestione resize fluido su mobile (quando scompare/appare la barra indirizzi)
    var resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            if (viewer) {
                viewer.updateSize(); // Forza Marzipano ad adattarsi alle nuove dimensioni
            }
            if (map) {
                map.invalidateSize(); // Ridisegna la mappa correttamente
            }
        }, 200);
    });
    
    // Contrae la mappa automaticamente quando l'utente interagisce con il panorama
    if (viewer && viewer.controls) {
        viewer.controls().addEventListener('active', function() {
            var mapBox = document.getElementById('map-box');
            if (mapBox && !mapBox.classList.contains('collapsed')) {
                mapBox.classList.add('collapsed');
                // Aggiorna la dimensione interna di Leaflet per evitare bug grafici
                setTimeout(function() { if (map) map.invalidateSize(); }, 300);
            }
            // UI sempre visibile - auto-hide disattivato
        });
    }
    
    // Auto-hide disattivato - non aggiungere event listener per showUI
    // La barra rimane sempre aperta di default
    
    // Mostra il titolo per qualche secondo dopo il caricamento iniziale
    setTimeout(function() {
        openInfoTitle(true);
    }, 1000); // Aspetta 1 secondo dopo il load per "srotolare"
}

// Precarica tutte le scene in background con caricamento aggressivo delle texture
function preloadScenes() {
    // Precaricamento aggressivo disattivato per ridurre latenza iniziale
    console.log('ℹ️ Precaching disattivato (aggressivo off)');
}

function switchScene(index) {
    var data = scenes[index];
    // Transizione più lunga per mascherare il caricamento tiles su GitHub Pages
    data.scene.switchTo({ transitionDuration: 1200 });
    
    // Forza dissolvenza fluida con CSS opacity per nascondere i buchi durante il caricamento
    var panoEl = document.getElementById('pano');
    if (panoEl) {
        panoEl.style.opacity = '0';
        setTimeout(function() {
            panoEl.style.transition = 'opacity 0.9s ease';
            panoEl.style.opacity = '1';
        }, 100);
    }
    // Ripristina yaw/pitch/fov alla vista iniziale ogni volta che si entra nella scena
    try {
        var initial = (window.data && window.data.scenes && window.data.scenes[index]) ? window.data.scenes[index].initialViewParameters : null;
        if (initial) {
            data.view.setParameters(initial, { transitionDuration: 0 });
        }
    } catch (e) { /* non critico */ }

    currentView = data.view;
    currentSceneIndex = index;
    
    // Riapri la mappa e resetta lo zoom alla vista predefinita
    var mapBox = document.getElementById('map-box');
    if (mapBox && mapBox.classList.contains('collapsed')) {
        mapBox.classList.remove('collapsed');
        var coords = document.getElementById('map-coordinates');
        if (coords) coords.style.display = 'block'; // Mostra coordinate quando apri mappa
        setTimeout(function() { if (map) map.invalidateSize(); }, 300);
    }
    
    // Resetta la vista della mappa per mostrare tutti i marker
    if (map && markers && markers.length > 0) {
        try {
            var bounds = L.latLngBounds(scenes.map(s => [s.lat, s.lng]));
            map.fitBounds(bounds, {padding: [30,30]});
        } catch(e) {
            // Fallback: centra solo sulla scena corrente
            map.panTo([data.lat, data.lng]);
        }
    }
    
    markers.forEach((m, i) => m.setStyle({ fillColor: i === index ? "#27ae60" : "#3498db" }));
    
    // Aggiorna coordinate sulla mappa
    updateMapCoordinates();

    // Creazione Hotspot Nativa
    if (window.data && window.data.scenes[index]) {
        var sceneData = window.data.scenes[index];
        var container = data.scene.hotspotContainer();

        // Rimuovi eventuali hotspot precedenti (protezione contro rimozioni accidentali)
        try {
            document.querySelectorAll('.hotspot-info').forEach(n => n.remove());
        } catch (e) { /* non critico */ }

        if (sceneData.infoHotspots && sceneData.infoHotspots.length) {
            sceneData.infoHotspots.forEach((hs, i) => {
                var el = document.createElement('div');
                el.className = 'hotspot-info';
                el.innerHTML = '<span class="hotspot-plus">i</span>';
                el.onclick = (e) => { e.stopPropagation(); showInfoHotspot(hs.title, hs.text, hs.image || null); };
                container.createHotspot(el, { yaw: hs.yaw, pitch: hs.pitch });
            });
            data.hotspotsCreated = true;
        } else {
            data.hotspotsCreated = false;
        }
    }

    // Avvia autorotazione solo se consentita
    if (!rotationLocked) {
        startAutoRotation();
    } else {
        stopAutoRotation();
    }

    document.querySelectorAll('.scene-btn').forEach((b, i) => b.classList.toggle('active', i === index));
    document.querySelectorAll('.thumb-item').forEach((t, i) => t.classList.toggle('active', i === index));
    refreshSceneCaption(index);
    // Con immagini equirettangolari, il caricamento progressivo è gestito automaticamente
    
    // Mostra il titolo per qualche secondo quando cambia la scena
    openInfoTitle(true);
}

function navigateScene(dir) {
    let next = currentSceneIndex + dir;
    if (next >= 0 && next < scenes.length) switchScene(next);
}

// Centra mappa su tutti i marker
function centerMapOnMarkers() {
    if (map && scenes && scenes.length > 0) {
        try {
            var bounds = L.latLngBounds(scenes.map(s => [s.lat, s.lng]));
            map.fitBounds(bounds, {padding: [30,30]});
        } catch(e) {
            console.warn('Errore centratura mappa:', e);
        }
    }
}

// Aggiorna coordinate panorama corrente
function updateMapCoordinates() {
    var coordsEl = document.getElementById('map-coordinates');
    if (coordsEl && scenes && scenes[currentSceneIndex]) {
        var lat = scenes[currentSceneIndex].lat.toFixed(4);
        var lng = scenes[currentSceneIndex].lng.toFixed(4);
        coordsEl.textContent = '[' + lat + ', ' + lng + ']';
    }
}

function toggleMap() {
    var mapBox = document.getElementById('map-box');
    var coords = document.getElementById('map-coordinates');
    if (!mapBox) return;
    mapBox.classList.toggle('collapsed');
    // Nascondi/mostra coordinate via JavaScript
    if (coords) {
        if (mapBox.classList.contains('collapsed')) {
            // Nascondi completamente il testo quando la mappa è chiusa
            coords.style.visibility = 'hidden';
            coords.innerHTML = '';
        } else {
            coords.style.visibility = 'visible';
            updateMapCoordinates(); // Riempie i dati
        }
    }
    if (typeof map !== 'undefined' && map && typeof map.invalidateSize === 'function') {
        setTimeout(() => map.invalidateSize(), 200);
    }
}

function toggleControls() {
    document.getElementById('controls-wrapper').classList.toggle('collapsed');
}

// Abilita espansione/contrazione della galleria al passaggio del mouse
function enableGalleryHover() {
    var cw = document.getElementById('controls-wrapper');
    if (!cw) return;
    var enterTimer = null;
    var leaveTimer = null;
    var enterDelay = 80; // ms - ridotto per maggiore reattività
    var leaveDelay = 200; // ms - ridotto per maggiore reattività

    cw.addEventListener('mouseenter', function() {
        if (leaveTimer) { clearTimeout(leaveTimer); leaveTimer = null; }
        if (enterTimer) clearTimeout(enterTimer);
        enterTimer = setTimeout(function() { cw.classList.remove('collapsed'); enterTimer = null; }, enterDelay);
    });

    cw.addEventListener('mouseleave', function() {
        if (enterTimer) { clearTimeout(enterTimer); enterTimer = null; }
        if (leaveTimer) clearTimeout(leaveTimer);
        leaveTimer = setTimeout(function() { cw.classList.add('collapsed'); leaveTimer = null; }, leaveDelay);
    });

    // Anche il pulsante hover (piccolo) deve aprire al passaggio
    var hoverBtn = document.getElementById('gallery-hover-toggle');
    if (hoverBtn) {
        hoverBtn.addEventListener('mouseenter', function() { if (leaveTimer) { clearTimeout(leaveTimer); leaveTimer = null; } cw.classList.remove('collapsed'); });
        hoverBtn.addEventListener('mouseleave', function() { if (leaveTimer) clearTimeout(leaveTimer); leaveTimer = setTimeout(function(){ cw.classList.add('collapsed'); }, leaveDelay); });
    }
    
    // Bottone dentro la barra con click diretto
    var toggleBarBtn = document.getElementById('gallery-toggle-bar');
    if (toggleBarBtn) {
        toggleBarBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            // Cancella i timeout pendenti per rimozione immediata
            if (leaveTimer) { clearTimeout(leaveTimer); leaveTimer = null; }
            if (enterTimer) { clearTimeout(enterTimer); enterTimer = null; }
            console.log('✓ Gallery toggle clicked');
            cw.classList.toggle('collapsed');
        });
    }
}

// Esegui quando il DOM è pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', enableGalleryHover);
} else {
    enableGalleryHover();
}

function zoomIn() {
    map.zoomIn();
}

function zoomOut() {
    map.zoomOut();
}

function toggleLayer() {
    if (!layers || !layers.length) return;
    var next = (currentLayerIndex + 1) % layers.length;
    setLayer(next);
}

function setLayer(index) {
    if (!layers || !layers.length) return;
    if (typeof index !== 'number' || index < 0 || index >= layers.length) {
        console.warn('setLayer: indice non valido', index);
        return;
    }
    // rimuovi solo i tile-layer definiti in `layers` (non toccare marker/altre overlay)
    try {
        layers.forEach((l, i) => {
            try {
                if (i !== index && map && map.hasLayer && map.hasLayer(l.layer)) map.removeLayer(l.layer);
            } catch(e) { /* ignora singoli errori */ }
        });
    } catch(e) { console.warn('setLayer: errore rimozione layer', e); }
    // aggiungi nuovo layer se non è già presente
    try {
        if (map && !map.hasLayer(layers[index].layer)) layers[index].layer.addTo(map);
    } catch(e) { console.warn('setLayer: errore aggiunta layer', e); }
    currentLayerIndex = index;
    // aggiorna UI: icona, nome layer, attribuzione
    var btn = document.getElementById('layer-toggle');
    if (btn) {
        btn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M12 3L2 8l10 5 10-5-10-5z" fill="currentColor"/>
                <path d="M12 10l-10 5 10 5 10-5-10-5z" fill="currentColor" opacity="0.9"/>
                <path d="M12 17l-10 5 10 5 10-5-10-5z" fill="currentColor" opacity="0.7" transform="translate(0,-8) scale(0.9)"/>
            </svg>`;
        btn.title = getTranslation('changeLayer') || 'Cambia strato';
        btn.classList.add('pulse');
        setTimeout(() => btn.classList.remove('pulse'), 380);
    }
    var nameEl = document.getElementById('map-layer-name');
    if (nameEl) nameEl.innerText = layers[index].name;
    var attr = document.getElementById('map-attribution');
    if (attr) attr.innerText = layers[index].attribution || '';
    // aggiorna stato menu se visibile
    var menu = document.getElementById('layer-menu');
    if (menu) {
        Array.from(menu.children).forEach((ch, i) => ch.classList.toggle('active', i === index));
    }
    // Forza ridisegno mappa per assicurarsi che i tiles vengano richiesti
    try { if (map && typeof map.invalidateSize === 'function') map.invalidateSize(); } catch(e) {}
}

function toggleLayerMenu(e) {
    e && e.stopPropagation && e.stopPropagation();
    var menu = document.getElementById('layer-menu');
    if (!menu) return;
    menu.classList.toggle('show');
}

function hideLayerMenu() {
    var menu = document.getElementById('layer-menu');
    if (menu) menu.classList.remove('show');
}

// Crea le voci del menu layer
function buildLayerMenu() {
    var menu = document.getElementById('layer-menu');
    if (!menu || !layers) return;
    menu.innerHTML = '';
    layers.forEach((l, i) => {
        var it = document.createElement('div');
        it.className = 'layer-item' + (i === currentLayerIndex ? ' active' : '');
        it.innerHTML = `<span style="width:20px">${l.icon}</span><span>${l.name}</span>`;
        // usa addEventListener per evitare problemi di scoping/override
        it.addEventListener('click', function(ev) { ev.stopPropagation(); setLayer(i); hideLayerMenu(); });
        menu.appendChild(it);
    });
}

// nascondi menu cliccando fuori
document.addEventListener('click', function(e) { hideLayerMenu(); });
document.addEventListener('touchstart', function(e) { hideLayerMenu(); });

function updateRotationButton() {
    var btn = document.getElementById('rotation-toggle');
    if (!btn) return;
    
    // Icona PAUSA (Due barre verticali)
    var svgPause = '<svg viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>';
    // Icona PLAY (Triangolo)
    var svgPlay = '<svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';

    // Il pulsante resta sempre visibile, cambia solo stato/iconografia
    btn.style.display = 'inline-flex';
    if (rotationLocked) {
        btn.classList.add('locked');
        btn.innerHTML = svgPlay; // Mostra Play perché è fermo
        btn.title = 'Blocca/Sblocca rotazione';
        btn.setAttribute('aria-label', 'Blocca/Sblocca rotazione');
        // Colore rosso quando fermo
        var svg = btn.querySelector('svg');
        if (svg) svg.style.stroke = '#ff6b6b';
    } else {
        btn.classList.remove('locked');
        btn.innerHTML = svgPause; // Mostra Pausa perché sta girando
        btn.title = 'Blocca/Sblocca rotazione';
        btn.setAttribute('aria-label', 'Blocca/Sblocca rotazione');
        // Torna bianco
        var svg = btn.querySelector('svg');
        if (svg) svg.style.stroke = '';
    }
}

function stopAutoRotation() {
    try { viewer.stopMovement(); } catch(e) {}
    // Impedisci riavvio automatico della rotazione
    try { viewer.setIdleMovement(Infinity); } catch(e) { try { viewer.setIdleMovement(false); } catch(_) {} }
    // Forza l'azzeramento di qualsiasi movimento impostando la view
    try {
        if (currentView && typeof currentView.yaw === 'function') {
            var _y = currentView.yaw();
            var _p = currentView.pitch();
            if (typeof currentView.setYaw === 'function') currentView.setYaw(_y);
            if (typeof currentView.setPitch === 'function') currentView.setPitch(_p);
        }
    } catch(e) { /* non critico */ }
}

function startAutoRotation() {
    try {
        viewer.startMovement(autorotate);
        viewer.setIdleMovement(3000, autorotate);
    } catch(e) {}
    rotationLocked = false;
    rotationLockMode = null;
    updateRotationButton();
}

function toggleRotation(e) {
    // Previeni che il click sul pulsante venga intercettato da altri handler (es. del viewer)
    try { if (e) { e.stopImmediatePropagation(); e.preventDefault(); } } catch(err) {}

    var btn = document.getElementById('rotation-toggle');
    if (!rotationLocked) {
        // manual lock (pausa)
        rotationLocked = true;
        rotationLockMode = 'manual';
        stopAutoRotation();

        // Forza fissaggio angoli per evitare inerzia
        try {
            if (currentView && typeof currentView.yaw === 'function') {
                var _y = currentView.yaw();
                var _p = currentView.pitch();
                if (typeof currentView.setYaw === 'function') currentView.setYaw(_y);
                if (typeof currentView.setPitch === 'function') currentView.setPitch(_p);
            }
        } catch(err) {}

        // Disabilita brevemente i controlli del viewer per evitare che un drag/click subito dopo riattivi il movimento
        try { if (viewer && typeof viewer.controls === 'function' && viewer.controls().disable) { viewer.controls().disable(); setTimeout(()=>{ try{ viewer.controls().enable(); }catch(e){} }, 50); } } catch(err) {}

        // cancel any temporary timer
        if (rotationTimer) { clearTimeout(rotationTimer); rotationTimer = null; }
    } else {
        // unlock (play)
        rotationLocked = false;
        rotationLockMode = null;
        // cancel timer if present
        if (rotationTimer) { clearTimeout(rotationTimer); rotationTimer = null; }
        startAutoRotation();
    }
    updateRotationButton();
}

function toggleFullscreen() {
    var doc = window.document;
    var docEl = doc.documentElement;

    var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
    var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

    // Verifica lo stato di fullscreen con tutti i prefissi
    var isFullscreen = doc.fullscreenElement || doc.mozFullScreenElement || doc.webkitFullscreenElement || doc.msFullscreenElement;

    if (!isFullscreen) {
        // Richiedi fullscreen
        if (requestFullScreen) {
            requestFullScreen.call(docEl).catch(function(err) {
                console.log('Fullscreen non disponibile:', err);
            });
        }
    } else {
        // Esci da fullscreen
        if (cancelFullScreen) {
            cancelFullScreen.call(doc).catch(function(err) {
                console.log('Exit fullscreen error:', err);
            });
        }
    }
}

// Quando la rotazione è bloccata, assicuriamoci che qualsiasi click/touch non riattivi
function enforceRotationLockOnInteraction(e) {
    // Ignora interazioni originate dal pulsante di controllo della rotazione
    try {
        if (e && e.target && typeof e.target.closest === 'function' && e.target.closest('#rotation-toggle')) return;
    } catch (err) {}

    if (!rotationLocked || rotationLockMode === 'temporary') {
        rotationLocked = true;
        rotationLockMode = 'temporary';
        stopAutoRotation();
        if (rotationTimer) clearTimeout(rotationTimer);
        rotationTimer = setTimeout(() => {
            if (rotationLockMode === 'temporary') {
                rotationLocked = false;
                rotationLockMode = null;
                startAutoRotation();
                updateRotationButton();
            }
            rotationTimer = null;
        }, 30 * 1000); // Ridotto a 30s per maggiore reattività
    }
    updateRotationButton();
}

// Listener in capturing phase per intercettare prima degli handler UI
document.addEventListener('click', enforceRotationLockOnInteraction, true);
// Touch listener con passive: true per migliori performance e evitare blocchi
document.addEventListener('touchend', enforceRotationLockOnInteraction, { capture: true, passive: true });
document.addEventListener('mousedown', enforceRotationLockOnInteraction, true);

// --- LOADER ---
function showLoader(message) {
    var loader = document.createElement('div');
    loader.id = 'tour-loader';
    loader.innerHTML = `
        <div style="position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px">
            <div style="width:60px;height:60px;border:4px solid rgba(255,255,255,0.2);border-top-color:#3498db;border-radius:50%;animation:spin 1s linear infinite"></div>
            <div style="color:#fff;font-size:16px;font-weight:500">${message}</div>
        </div>
    `;
    var style = document.createElement('style');
    style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
    document.head.appendChild(style);
    document.body.appendChild(loader);
}

function hideLoader() {
    var loader = document.getElementById('tour-loader');
    if (loader) {
        loader.style.opacity = '0';
        loader.style.transition = 'opacity 0.2s ease';
        setTimeout(() => loader.remove(), 200);
    }
}
// Avvia l'app solo dopo che il DOM è pronto così gli elementi (didascalia inclusa) esistono già
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}

// --- MODALE INFORMAZIONI HOTSPOT (custom, evita alert nativo con origine) ---
// showInfoHotspot(title, text, imageUrl)
function showInfoHotspot(title, text, imageUrl) {
    // Cerca traduzione del hotspot
    var translation = getHotspotTranslation(title);
    var displayTitle = translation ? translation.title : (title || '');
    var displayText = translation ? translation.text : (text || '');
    
    var existing = document.getElementById('info-modal');
    if (!existing) {
        var modal = document.createElement('div');
        modal.id = 'info-modal';
        modal.innerHTML = `
            <div class="info-backdrop" id="info-backdrop"></div>
            <div class="info-content" role="dialog" aria-modal="true" aria-labelledby="info-title">
                <button class="info-close" id="info-close" aria-label="Chiudi">✕</button>
                <div class="info-flex">
                    <div class="info-text">
                        <h3 id="info-title"></h3>
                        <div id="info-body"></div>
                    </div>
                    <div class="info-image" id="info-image" aria-hidden="true">
                        <img id="info-image-img" src="" alt="" />
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // styles inline per semplicità
        var css = `
            #info-modal { position: fixed; inset: 0; z-index: 20000; display: block; }
            #info-modal .info-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.6); }
            #info-modal .info-content { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%);
                width: min(760px, calc(100% - 40px)); 
                max-height: calc(100vh - 80px);
                overflow-y: auto;
                background: linear-gradient(180deg,#0f0f12, #0b0c11);
                color: #fff; padding: 24px 24px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.6);
                border: 1px solid rgba(255,255,255,0.1);
                font-family: 'Segoe UI', 'Inter', system-ui, sans-serif;
            }
            #info-modal .info-close { position: absolute; right: 14px; top: 14px; background: transparent; border: none; color: #fff; font-size: 18px; cursor: pointer; }
            #info-modal .info-flex { display: flex; gap: 14px; align-items: flex-start; }
            #info-modal .info-text { flex: 1 1 60%; }
            #info-modal .info-image { flex: 0 0 180px; display: none; }
            #info-modal .info-image img { width: 100%; height: auto; border-radius: 6px; display:block }
            #info-modal h3 { margin: 2px 0 8px 0; font-size: 18px; letter-spacing: 0.3px; }
            #info-modal #info-body { font-size: 14px; color: #ddd; white-space: pre-wrap; line-height: 1.6; letter-spacing: 0.5px; }
        `;
        var style = document.createElement('style'); style.appendChild(document.createTextNode(css)); document.head.appendChild(style);

        // events
        modal.querySelector('#info-close').addEventListener('click', hideInfoHotspot);
        modal.querySelector('#info-backdrop')?.addEventListener('click', hideInfoHotspot);
        document.addEventListener('keydown', function onEsc(e){ if (e.key === 'Escape') hideInfoHotspot(); });
    }
    document.getElementById('info-title').innerText = displayTitle;
    document.getElementById('info-body').innerText = displayText;
    // image handling - applica il baseURL se il percorso è relativo
    var imgWrap = document.getElementById('info-image');
    var imgEl = document.getElementById('info-image-img');
    if (imageUrl) {
        // Se il percorso non inizia con http/https e non è assoluto (/), prependi baseURL
        var fullImageUrl = (imageUrl.startsWith('http') || imageUrl.startsWith('/')) 
            ? imageUrl 
            : baseURL + imageUrl;
        imgEl.src = fullImageUrl;
        imgEl.alt = title || '';
        imgWrap.style.display = 'block';
    } else {
        imgEl.src = '';
        imgWrap.style.display = 'none';
    }
    document.getElementById('info-modal').style.display = 'block';
}

function hideInfoHotspot() {
    var m = document.getElementById('info-modal');
    if (m) m.style.display = 'none';
}

// --- TOGGLE BAR FUNCTION ---
function toggleBar() {
    const bar = document.getElementById('control-bar');
    const toggle = document.getElementById('bar-toggle');
    const titleWrapper = document.getElementById('title-wrapper');
    
    // Icona CHEVRON DOWN (Chiudi)
    var svgDown = '<svg viewBox="0 0 24 24"><path d="M7 13l5 5 5-5M7 6l5 5 5-5"></path></svg>';
    // Icona CHEVRON UP (Apri)
    var svgUp = '<svg viewBox="0 0 24 24"><path d="M7 11l5-5 5 5M7 18l5-5 5 5"></path></svg>';
    
    // Attiviamo il flag manualToggle per fermare l'auto-hide automatico 
    // se l'utente decide di chiudere/aprire da solo
    manualToggle = true; 

    bar.classList.toggle('collapsed');
    if (titleWrapper) titleWrapper.classList.toggle('collapsed', bar.classList.contains('collapsed'));
    
    if (bar.classList.contains('collapsed')) {
        toggle.innerHTML = svgUp; // Icona per riaprire (freccia su)
        toggle.title = getTranslation('showBar');
        // Abbassa il titolo quando la barra è chiusa
        if (titleWrapper) titleWrapper.style.bottom = '20px';
    } else {
        toggle.innerHTML = svgDown; // Icona per chiudere
        toggle.title = getTranslation('hideBar');
        // Rialza il titolo sopra la barra aperta
        if (titleWrapper) titleWrapper.style.bottom = 'calc(var(--bar-height) + 15px)';
    }
}

// Disabilita auto-hide su mobile
if (window.innerWidth < 768) {
    manualToggle = true;
}
</script>

<!-- Control Bar (Due livelli: superiore con controlli, inferiore con thumbnails) -->
<button id="bar-toggle" title="Mostra/Nascondi barra" aria-label="Mostra o nascondi la barra di controllo" onclick="toggleBar()">
    <svg viewBox="0 0 24 24" id="icon-bar-toggle">
        <path d="M7 13l5 5 5-5M7 6l5 5 5-5"></path>
    </svg>
</button>

<div id="control-bar">
    <!-- TOP ROW (44px): Controlli -->
    <div id="control-bar-top">
        <div class="control-group"></div>
        <div id="scene-caption"></div>
        <div class="control-group">
            <button id="gyro-toggle" class="control-btn" onclick="toggleGyro()" title="Modalità Visore (Giroscopio)" aria-label="Modalità Visore (Giroscopio)">
                <svg viewBox="0 0 24 24">
                    <path d="M6 9l2.5-4h7l2.5 4H6zM2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6H2zm4 3a2 2 0 100 4 2 2 0 000-4zm12 0a2 2 0 100 4 2 2 0 000-4z" />
                </svg>
            </button>
            <button id="rotation-toggle" class="control-btn" onclick="toggleRotation(event)" title="Blocca/Sblocca rotazione" aria-label="Blocca/Sblocca rotazione">
                <svg viewBox="0 0 24 24" id="icon-rotation">
                    <rect x="6" y="4" width="4" height="16"></rect>
                    <rect x="14" y="4" width="4" height="16"></rect>
                </svg>
            </button>
            <button id="fullscreen-toggle" class="control-btn" onclick="toggleFullscreen()" title="Schermo intero" aria-label="Schermo intero">
                <svg viewBox="0 0 24 24">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- BOTTOM ROW (variabile): Miniature -->
    <div id="control-bar-bottom">
        <div class="thumb-row">
            <div class="control-group">
                <button class="control-btn" id="prev-scene-btn" onclick="navigateScene(-1)" title="Vista precedente" aria-label="Vista precedente">❮</button>
            </div>
            <div id="thumb-track"></div>
            <div class="control-group">
                <button class="control-btn" id="next-scene-btn" onclick="navigateScene(1)" title="Vista successiva" aria-label="Vista successiva">❯</button>
            </div>
        </div>
    </div>
</div>

</body>
</html>